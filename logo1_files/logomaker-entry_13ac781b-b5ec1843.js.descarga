(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{206:function(e,t,r){var o,n,i,a=t,l=r(0),s=r(1),u=r(4),c=r(8),h=r(9),d=r(253),m=r(15);a.kAllowMultipleDragsInFlight=!1,a.debug_print=function(e,t,r){void 0===t&&(t=" "),void 0===r&&(r="\n")},a.debug_print=function(e,t,r,o){void 0===r&&(r=" "),void 0===o&&(o="\n")},a.debug_print=function(e,t,r,o,n){void 0===o&&(o=" "),void 0===n&&(n="\n")},a.debug_print=function(e,t,r,o,n,i){void 0===n&&(n=" "),void 0===i&&(i="\n")},a.debug_print=function(e,t,r,o,n,i,a){void 0===i&&(i=" "),void 0===a&&(a="\n")},a.debug_print=function(e,t,r,o,n,i,a,l){void 0===a&&(a=" "),void 0===l&&(l="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s){void 0===l&&(l=" "),void 0===s&&(s="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s,u){void 0===s&&(s=" "),void 0===u&&(u="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s,u,c){void 0===u&&(u=" "),void 0===c&&(c="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s,u,c,h){void 0===c&&(c=" "),void 0===h&&(h="\n")},a.dot=function(e,t){return e.dotProduct(t)},a.cross=function(e,t){return e.x*t.y-e.y*t.x},a.concat=function(e,t,r){return h.Matrix2D.concat2(h.Matrix2D.concat2(e,t),r)},a.scale=function(e,t){return new m.TheoPoint(e*t.x,e*t.y)},a.blend=function(e,t,r){return a.scale(1-t,e).add(a.scale(t,r))},a.midpoint=function(e,t){return a.blend(e,.5,t)},a.moveBy=function(e){return h.Matrix2D.translation(e)},a.move=function(e,t){return a.moveBy(t.subtract(e))},a.PointerDrag=(o=function(e,t){this.begin=e,this.end=t},l.defineClass({name:"PointerDrag",ctor:o}),o),a.freeMovement_=function(e){if(1==e.length)return{movement:a.move(e[0].begin,e[0].end),rise:0,run:1};if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(m.TheoPoint.ZERO)&&r.equal(m.TheoPoint.ZERO))return{movement:a.move(e[0].begin,e[0].end),rise:0,run:1};if(t.equal(m.TheoPoint.ZERO))return{movement:a.move(e[0].begin,e[0].end),rise:0,run:1};var o=a.dot(t,t),n=a.dot(t,r),i=a.cross(t,r),l=n/o,u=i/o,c=new h.Matrix2D(l,u,-u,l,0,0),d=a.concat(a.moveBy(e[0].begin.invert()),c,a.moveBy(e[0].end));return s.CoreAssert.isTrue(0!=d.determinant),{movement:d,rise:i,run:n}}return{movement:h.Matrix2D.Identity,rise:0,run:1}},a.MoorePenrose10011001=function(e,t,r,o,n,i,a,s){var u=e-r,c=t-o,h=u*u,d=c*c,m=2*(h+d),f=c*(e+r),p=u*(t+o),g=[[2*u,2*c,-2*u,-2*c],[d-2*r*u,-f,d+2*e*u,f],[-p,h-2*o*c,p,h+2*t*c]];g=g.map(function(e){return e.map(function(e){return e/m},this)},this);var v=g.map(function(e){return function(e,t){return l.zip(l.clone(e),l.clone(t)).map(function(e){return e[0]*e[1]},this).reduce(function(e,t){return e+t},0)}(l.clone(e),[n,i,a,s])},this);return{u:v[0],v:v[1],w:v[2]}},a.noRotation_=function(e){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(m.TheoPoint.ZERO)&&r.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(t.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var o=a.MoorePenrose10011001(e[0].begin.x,e[0].begin.y,e[1].begin.x,e[1].begin.y,e[0].end.x,e[0].end.y,e[1].end.x,e[1].end.y),n=o.u,i=o.v,l=o.w;return new h.Matrix2D(n,0,0,n,i,l)}return h.Matrix2D.Identity},a.noRotation2_=function(e,t){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var r=e[1].begin.subtract(e[0].begin),o=e[1].end.subtract(e[0].end);if(r.equal(m.TheoPoint.ZERO)&&o.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(r.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var n=a.MoorePenrose10011001(e[0].begin.x,e[0].begin.y,e[1].begin.x,e[1].begin.y,e[0].end.x,e[0].end.y,e[1].end.x,e[1].end.y),i=n.u;n.v,n.w;return a.concat(a.moveBy(t.invert()),new h.Matrix2D(i,0,0,i,0,0),a.moveBy(t))}return h.Matrix2D.Identity},a.noScale_=function(e){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(m.TheoPoint.ZERO)&&r.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(t.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var o=a.MoorePenrose10011001(-e[0].begin.y,e[0].begin.x,-e[1].begin.y,e[1].begin.x,e[0].end.x-e[0].begin.x,e[0].end.y-e[0].begin.y,e[1].end.x-e[1].begin.x,e[1].end.y-e[1].begin.y),n=o.u,i=o.v,l=o.w;return new h.Matrix2D(Math.cos(n),Math.sin(n),-Math.sin(n),Math.cos(n),i,l)}return h.Matrix2D.Identity},a.noScale2_=function(e){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(m.TheoPoint.ZERO)&&r.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(t.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var o=a.dot(t,t),n=a.dot(r,r),i=a.dot(t,r),l=a.cross(t,r),u=Math.sqrt(o*n),c=i/u,d=l/u,f=new h.Matrix2D(c,d,-d,c,0,0),p=a.concat(a.moveBy(a.midpoint(e[0].begin,e[1].begin).invert()),f,a.moveBy(a.midpoint(e[0].end,e[1].end)));return s.CoreAssert.isTrue(0!=p.determinant),p}return h.Matrix2D.Identity},a.noScale3_=function(e,t){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var r=e[1].begin.subtract(e[0].begin),o=e[1].end.subtract(e[0].end);if(r.equal(m.TheoPoint.ZERO)&&o.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(r.equal(m.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var n=a.dot(r,r),i=a.dot(o,o),l=a.dot(r,o),u=a.cross(r,o),c=Math.sqrt(n*i),d=l/c,f=u/c,p=new h.Matrix2D(d,f,-f,d,0,0),g=a.concat(a.moveBy(t.invert()),p,a.moveBy(t));return s.CoreAssert.isTrue(0!=g.determinant),g}return h.Matrix2D.Identity},a.closestApproach_=function(e,t,r,o){var n=e.subtract(r),i=o.subtract(t),l=a.dot(i,i);return 0==l?{distance:Math.sqrt(a.dot(n,n)),time:0}:{distance:a.cross(i,n)/Math.sqrt(l),time:a.dot(i,n)/l}},a.DragPace=l.defineEnum("DragPace",{StoppedPace:0,SlowPace:1,MediumPace:2,FastPace:3}),a.DragMode=l.defineEnum("DragMode",{UniformScaleNoSkew:0,NoScaleNoSkew:1,UniformScaleNoRotationNoSkew:2}),a.ActiveDragDelegateProtocol=l.defineProtocol("ActiveDragDelegateProtocol",{modifierKeys:"Dictionary<String>",activeDragDidBegin:"(ActiveDrag) -> Void",activeDragDidActivate:"(ActiveDrag) -> Boolean",activeDragDidDeactivate:"(ActiveDrag, Boolean) -> Void",activeDragClaimNewPointers:"(ActiveDrag, Array<PointerState>, Boolean) -> Array<PointerState>",activeDragDidCommit:"(ActiveDrag) -> Void",activeDragDidMove:"(ActiveDrag, DragPace) -> Void",activeDragDidChangePace:"(ActiveDrag, DragPace, DragPace) -> Void",activeDragHeldPointerEndedAsTap:"(ActiveDrag, PointerState) -> Void",activeDragDidEnd:"(ActiveDrag, Boolean, Array<PointerState>) -> Void"}),a.ActiveDrag=(n=function(e,t,r,o,n){this.initiated=!1,this.dragMode_=a.DragMode.UniformScaleNoSkew,this.pointers=[],this.totalMovement=h.Matrix2D.Identity,this.currentlySnapped_=!1,this.activationClock_=0,this._assignment=0,this.activeDragDelegate=t,this.pointerStateMachine=e,this.currentPace=a.DragPace.MediumPace,this.stoppedUtmost=9,this.slowUtmost=48,this.mediumUtmost=300,this.stoppedSlack=.5,this.slowSlack=.333,this.transientSlack=.333,this.futurePace=this.currentPace,this.pointers=[],this.uncommitedMovement=h.Matrix2D.Identity,this.newDragPlacement_=o,this.viewportScale=n,u.CoreObject.call(this),this.commitWithNewPointers(r)},l.defineClass({name:"ActiveDrag",ctor:n,superName:"CoreObject",props:{dragMode:{get:function(){return this.dragMode_},set:function(e){this.dragMode_,this.dragMode_=e}},currentlySnapped:{get:function(){return this.currentlySnapped_},set:function(e){this.currentlySnapped_!=e&&(this.currentlySnapped_=e)}},startPaceTimer:function(){if(null==this.paceTimer){var e=this;this.paceTimer=c.Host.async.startTimer(.6,function(){var t;(t=e)&&(t.activePace(),t.paceTimer=null,t.startPaceTimer())})}},stopPaceTimer:function(){l.opt(this.paceTimer,function(e){return e.cancel()}),this.paceTimer=null},activeDragDidCommit:function(){this.activeDragDelegate.activeDragDidCommit(this)},commitDrag:function(){this.slipPointers(!1),this.activeDragDidCommit(),this.totalMovement=h._asterisk_Matrix2D_Matrix2D(this.totalMovement,this.uncommitedMovement);var e=this.uncommitedMovement;return this.uncommitedMovement=h.Matrix2D.Identity,e},newDragPlacement:{get:function(){return this.newDragPlacement_},set:function(e){this.newDragPlacement_=e}},commitWithNewPointers:function(e,t){void 0===t&&(t=!0);for(var r=l.iter(e);!r.done;r.next()){var o=r.value;o.pointerStatus=d.PointerStatus.DragHeld,this.pointers.push(o)}this.commitDrag();var n=this.activationClock_,i=this;c.Host.async.postOnMainThread(.6,function(){var e;(e=i)&&(n==e.activationClock_&&e.activateAll()?a.debug_print("time activated"):a.debug_print("not time activated"))}),e.splice(0)},claimPointers:function(e,t){return this.activeDragDelegate.activeDragClaimNewPointers(this,l.clone(e),t)},activeDragDidDeactivate:function(){var e=this.currentlySnapped;this.currentlySnapped=!1,this.activeDragDelegate.activeDragDidDeactivate(this,e)},deactivateAll:function(){if(this.initiated){this.commitDrag();for(var e=l.iter(this.pointers);!e.done;e.next()){var t=e.value;t.pointerStatus==d.PointerStatus.DragActive&&(t.pointerStatus=d.PointerStatus.DragInactive)}this.stopPaceTimer(),this.activeDragDidDeactivate()}},activeDragDidBegin:function(){this.activeDragDelegate.activeDragDidBegin(this)},activeDragDidActivate:function(){return this.activeDragDelegate.activeDragDidActivate(this)},activeDragDidMove:function(){this.activeDragDelegate.activeDragDidMove(this,this.currentPace)},activeDragDidEnd:function(e){this.initiated&&this.stopPaceTimer(),this.activeDragDelegate.activeDragDidEnd(this,this.initiated,l.clone(e)),this.pointers.splice(0)},activateAll:function(){for(var e=!1,t=l.iter(this.pointers);!t.done;t.next()){var r=t.value;r.pointerStatus!=d.PointerStatus.DragActive&&(r.pointerStatus=d.PointerStatus.DragActive,e=!0)}return!!e&&(this.activationClock_+=1,this.initiated||(this.initiated=!0,this.activeDragDidBegin()),this.selectDragMode(),this.startPaceTimer(),this.activeDragDidActivate()&&this.slipPointers(!0),!0)},slipPointers:function(e){for(var t=l.iter(this.pointers);!t.done;t.next()){var r=t.value,o=m._minus_TheoPoint_TheoPoint(r.currentLocation,r.startLocation);r.slippage=e?m._plus_TheoPoint_TheoPoint(r.slippage,o):m.TheoPoint.ZERO,r.startLocation=r.currentLocation,r.startTime=r.currentTime}},selectDragMode:function(){var e=this;if(this.pointers.length<=1)return a.debug_print("just one pointer"),void(this.dragMode=a.DragMode.UniformScaleNoSkew);var t=function(t){return m._minus_TheoPoint_TheoPoint(e.pointers[t].currentLocation,e.pointers[t].startLocation)},r=t(0),o=t(1),n=a.dot(r,o)/r.length()/o.length(),i=n>.5;if(a.debug_print("cosine_subtended",n),i)return a.debug_print("same direction"),void(this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew);var l,s=h.Matrix2D.Identity;s=(l=this.pointers[0].viewportTransform)?l:h.Matrix2D.uniformScaling(this.viewportScale);var u=this.freeMovement(s),c=u.movement,d=u.rise,f=u.run,p=c.determinant;a.debug_print("activateAll",Math.sqrt(p),d/f);var g=this.closestApproach(),v=g.distance;if(g.time,1==p&&0==d)a.debug_print("==== translate"),this.dragMode=a.DragMode.UniformScaleNoSkew;else if(1==p)a.debug_print("==== rotate"),this.dragMode=a.DragMode.NoScaleNoSkew;else if(0==d)a.debug_print("==== scale"),this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew;else{var C=.7*Math.abs(1-Math.sqrt(p)),b=Math.abs(d/f);C>1.1*b&&C>.01?(a.debug_print("==== scale"),this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew):b>1.1*C&&b>.01?(a.debug_print("==== rotate"),this.dragMode=a.DragMode.NoScaleNoSkew):(a.debug_print("==== free"),this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew)}this.dragMode==a.DragMode.UniformScaleNoRotationNoSkew&&Math.abs(v)>100&&(a.debug_print("!!!!!!!!override"),this.dragMode=a.DragMode.NoScaleNoSkew)},notifyPaceChanged:function(e,t){},activeDragDidChangePace:function(e,t){this.notifyPaceChanged(e,t),this.activeDragDelegate.activeDragDidChangePace(this,e,t)},activePace:function(){var e,t=this.dragVelocity*this.viewportScale;if(e=t<=this.stoppedUtmost?a.DragPace.StoppedPace:t<this.slowUtmost?a.DragPace.SlowPace:t<this.mediumUtmost?a.DragPace.MediumPace:a.DragPace.FastPace,this.futurePace!=e){this._assignment+=1;var r=this._assignment;if(this.futurePace=e,this.currentPace!=this.futurePace){var o=this.transientSlack;this.futurePace==a.DragPace.SlowPace&&(o=this.slowSlack),this.futurePace==a.DragPace.StoppedPace&&(o=this.stoppedSlack);var n=this;c.Host.async.postOnMainThread(o,function(){var e;if((e=n)&&e._assignment==r){var t=e.currentPace;e.currentPace=e.futurePace,e.activeDragDidChangePace(t,e.currentPace),e.currentPace==a.DragPace.StoppedPace&&e.deactivateAll()}})}}return this.currentPace},dragVelocity:{get:function(){for(var e=0,t=l.iter(this.pointers);!t.done;t.next()){var r=t.value.pointerVelocity();r>e&&(e=r)}return e}},activePointers:function(e){for(var t=[],r=l.iter(this.pointers);!r.done;r.next()){var o=r.value;o.pointerStatus==d.PointerStatus.DragActive&&t.push(new a.PointerDrag(e.transformPoint(o.startLocation),e.transformPoint(o.currentLocation)))}return t},freeMovement:function(e){var t=l.clone(this.activePointers(e));return a.freeMovement_(l.clone(t))},noScale:function(e,t){var r=l.clone(this.activePointers(e));return a.noScale3_(l.clone(r),t)},noRotation:function(e,t){var r=l.clone(this.activePointers(e));return a.noRotation2_(l.clone(r),t)},closestApproach:function(){for(var e=[],t=l.iter(this.pointers);!t.done;t.next()){var r=t.value;r.pointerStatus==d.PointerStatus.DragActive&&(e.push(r),a.debug_print("gorg=======",r.currentTime))}if(e.length<=1)return{distance:0,time:0};var o=h.Matrix2D.uniformScaling(this.viewportScale),n=function(t){for(var r=o.transformPoint(e[t].startLocation),n=o.transformPoint(e[t].currentLocation),i=e[t].startTime,s=e[t].currentTime,u=r.equal(n)?m.TheoPoint.ZERO:n.subtract(r).multiply(1/(s-i)),c=l.iter(e[t].history);!c.done;c.next()){var h=c.value;a.debug_print("\t......... "+h)}return{point:n,velocity:u}},i=n(0),s=n(1);return a.closestApproach_(i.point,i.velocity,s.point,s.velocity)}}}),n),a.PointerStateMachineDelegateProtocol=l.defineProtocol("PointerStateMachineDelegateProtocol",{createDragsForPointers:"(PointerStateMachine, Array<PointerState>, Boolean, Integer) -> Array<PointerState>",activeDragDidFinish:"(PointerStateMachine, ActiveDrag) -> Void"}),a.PointerStateMachine=(i=function(e){this.trackingStarted_=!1,this.drags_=[],this.delegate=e,u.CoreObject.call(this)},l.defineClass({name:"PointerStateMachine",ctor:i,superName:"CoreObject",statics:{_implements:function(e){return"TheoMessageSubscriber"==e}},props:{attach:function(e,t){this.owner=e,this.subscription_=t.subscribe(this,d.PointersStateChangeMessage.TYPE)},detach:function(){l.opt(this.subscription_,function(e){return e.unsubscribe()}),this.subscription_=null,this.owner=null},onMessage:function(e){var t;(t=l.as(e,d.PointersStateChangeMessage))&&(this.trackingStarted_?t.changeType==d.PointersStateChangeTypeEnum.PointersDown?this.processDown(t):t.changeType==d.PointersStateChangeTypeEnum.PointersMoved?this.processMove(t):t.changeType==d.PointersStateChangeTypeEnum.PointersUp&&this.processUp(t):t.changeType==d.PointersStateChangeTypeEnum.PointersDown&&(this.trackingStarted_=!0,this.drags_=[],this.processDown(t)))},processDown:function(e){if(null!=e){for(var t=e,r=l.clone(t.pointers),o=l.iter(this.drags_);!o.done;o.next()){var n=o.value;r=l.clone(n.claimPointers(l.clone(r),a.kAllowMultipleDragsInFlight))}0!=r.length&&(r=l.clone(this.delegate.createDragsForPointers(this,l.clone(r),a.kAllowMultipleDragsInFlight,this.drags_.length)))}},appendDrag:function(e){this.drags_.push(e)},processMove:function(e){for(var t=l.iter(this.drags_);!t.done;t.next()){for(var r=t.value,o=r.viewportScale*r.viewportScale,n=[],i=l.iter(e.pointers);!i.done;i.next()){var s=i.value;r.pointers.includes(s)&&n.push(s)}if(0!=n.length){for(var u=l.iter(n);!u.done;u.next()){(s=u.value).pointerStatus,d.PointerStatus.DragActive;var c=m._minus_TheoPoint_TheoPoint(s.currentLocation,s.startLocation),h=c.dotProduct(c)*o;if(h>81){r.activateAll()&&a.debug_print("move activated",Math.sqrt(h));break}}r.initiated&&r.activeDragDidMove()}}},activeDragTouchesEnded:function(e,t){for(var r=l.iter(t);!r.done;r.next()){var o,n=r.value;n.pointerStatus==d.PointerStatus.DragHeld&&e.activeDragDelegate.activeDragHeldPointerEndedAsTap(e,n),null!=(o=l.indexOf(e.pointers,n))&&l.clone(e.pointers.splice(o,1))}e.commitDrag()},processUp:function(e){for(var t=0;t<this.drags_.length;){for(var r=this.drags_[t],o=[],n=l.iter(e.pointers);!n.done;n.next()){var i=n.value;r.pointers.includes(i)&&o.push(i)}o.length==r.pointers.length?(r.activeDragDidEnd(l.clone(o)),this.delegate.activeDragDidFinish(this,r),l.clone(this.drags_.splice(t,1))):(this.activeDragTouchesEnded(r,l.clone(o)),t+=1)}}}}),i)},246:function(e,t,r){var o,n=t,i=r(0),a=r(1),l=r(11),s=r(43),u=r(9),c=r(30),h=r(247),d=r(40),m=r(10);n.ShapeGroupController=(o=function(e,t,r){s.GroupController.call(this,e,t,r),i.opt(this.forma,function(e){return e.applyStyle(h.ShapeGroupStyle.createDefault())})},i.defineClass({name:"ShapeGroupController",ctor:o,superName:"GroupController",statics:{KIND:{get:function(){return"backed-group"}},PROPERTY_BACKING_SHAPE_ID:"backing-shape-id"},props:{selectable:{get:function(){return!1}},moveable:{get:function(){return!1}},rotateable:{get:function(){return!0}},shapeGroupStyle:{get:function(){var e;return(e=i.as(i.opt(this.forma,function(e){return e.style}),h.ShapeGroupStyle))?e:(i.opt(this.forma,function(e){return e.applyStyle(h.ShapeGroupStyle.createDefault())}),i.as(i.opt(this.forma,function(e){return e.style}),h.ShapeGroupStyle))}},backingArtworkID:{get:function(){return i.opt(this.shapeGroupStyle,function(e){return e.backingArtworkID})},set:function(e){i.opt(this.shapeGroupStyle,function(t){return t.backingArtworkID=e})}},encode:function(e){e.setOptionalStringProperty(o.PROPERTY_BACKING_SHAPE_ID,this.backingShapeID_)},decode:function(e){this.backingShapeID_=e.optionalStringProperty(o.PROPERTY_BACKING_SHAPE_ID)},addFormaToGroup:function(e){i.info("pre-add:\n"+this.forma.root.print()),s.GroupController.prototype.addFormaToGroup.call(this,e),i.info("post-add:\n"+this.forma.root.print()),this.updateBoundsFromChildren(),this.updateGroup(),i.info("post-add-update:\n"+this.forma.print())},setupWithFormae:function(e){for(var t,r=null,o=i.iter(e);!o.done;o.next()){var n=o.value;r=m.TheoRect.unionOf(r,n.finalFrame)}(t=r)&&i.opt(this.forma,function(e){return e.placement})&&(i.opt(this.forma,function(e){return e.bounds=m.TheoRect.fromSize(t.size)}),i.opt(this.forma,function(e){return e.placement=u.Matrix2D.translationXY(t.minX,t.minY)}));for(var a=i.iter(e);!a.done;a.next())n=a.value,s.GroupController.prototype.addFormaToGroup.call(this,n)},removeFormaFromGroup:function(e){s.GroupController.prototype.removeFormaFromGroup.call(this,e),this.updateBoundsFromChildren(),this.updateGroup()},childUpdate:function(e){void 0===e&&(e=null),this.updatedChild=e,this.updateBoundsFromChildren(),this.updateGroup()},updateBoundsFromChildren:function(){var e;this.blockUpdate||(this.beginBlockedUpdate(),(e=this.childrenBoundsInCoordSpace(u.Matrix2D.Identity))&&(i.opt(this.forma,function(t){return t.bounds=m.TheoRect.fromSize(e.size)}),i.opt(this.forma,function(t){return t.placement=u.Matrix2D.translationXY(e.minX,e.minY)})),this.endBlockedUpdate())},childrenBoundsInCoordSpace:function(e){for(var t=null,r=i.iter(this.forma.visitAsArray(l.FormaTraversal.JustChildren));!r.done;r.next()){var o=r.value;o.formaID!=this.backingShapeID_&&(t=m.TheoRect.unionOf(t,o.boundsInCoordSpace(o.placement.concat(e))))}return t},match:function(e){this.beginBlockedUpdate(),s.GroupController.prototype.match.call(this,e),this.endBlockedUpdate()},fit:function(e){var t;(t=this.forma)&&(t.bounds=m.TheoRect.fromSize(e.size),t.placement=u.Matrix2D.translation(e.origin),this.updateParentGroup())},updateGroup:function(){if(!this.blockUpdate){var e,t;if(s.GroupController.prototype.updateGroup.call(this),this.beginBlockedUpdate(),(e=i.opt(this.forma,function(e){return e.style}))&&(t=i.opt(this.forma,function(e){return e.bounds}))){var r=i.clone(this.forma.visitAsArray(l.FormaTraversal.JustChildren));if(null==this.backingShape_){for(var o=i.iter(r);!o.done;o.next()){var n=o.value;n.formaID==this.backingShapeID_&&n instanceof c.ShapeForma&&(this.backingShape_=i.as(n,c.ShapeForma))}if(null==this.backingShape_){this.backingShape_=i.as(this.forma.page.createForma(c.ShapeForma.KIND),c.ShapeForma),this.backingShapeID_=this.backingShape_.formaID;var h,m,f=this.forma;f.insertChildAt(this.backingShape_,0),i.info(f.print()),(h=this.shapeGroupStyle)&&null!=(m=h.backingArtworkID)&&d.ShapeLibrary.applyToShapeForma(this.backingShape_,m)}}this.backingShape_.style.opacity=e.opacity;var p=e.colors.fieldPrimary;a.CoreAssert.isTrue(null!=p,"no color"),this.backingShape_.style.colors.fieldPrimary=p,this.backingShape_.size=t.size,this.backingShape_.placement=u.Matrix2D.translation(t.origin)}this.endBlockedUpdate()}}}}),o)},25:function(e,t,r){var o,n,i=t,a=r(0),l=r(1),s=r(79),u=r(4),c=r(243),h=r(19),d=r(118),m=r(104),f=r(11),p=r(26),g=r(155),v=r(29),C=r(44),b=r(43),F=r(122),y=r(23),D=r(239),I=r(335),S=r(116),x=r(8),T=r(21),M=r(91),P=r(17),k=r(9),_=r(37),G=r(119),w=r(54),A=r(30),R=r(40),B=r(14),N=r(15),E=r(10),L=r(28);i.GridCellHandle=a.defineEnum("GridCellHandle",{Left:0,Right:1,Top:2,Bottom:3,TopLeft:4,TopRight:5,BottomLeft:6,BottomRight:7}),i.GridCell=(o=function(e,t,r){void 0===t&&(t=null),void 0===r&&(r=1),this.region_=e,this.colorID_=t,this.opacity_=r,u.CoreObject.call(this)},a.defineClass({name:"GridCell",ctor:o,superName:"CoreObject",statics:{positionForHandle:function(e){return e==i.GridCellHandle.Top?new N.TheoPoint(.5,0):e==i.GridCellHandle.Bottom?new N.TheoPoint(.5,1):e==i.GridCellHandle.Left?new N.TheoPoint(0,.5):e==i.GridCellHandle.Right?new N.TheoPoint(1,.5):e==i.GridCellHandle.TopLeft?new N.TheoPoint(0,0):e==i.GridCellHandle.TopRight?new N.TheoPoint(1,0):e==i.GridCellHandle.BottomLeft?new N.TheoPoint(0,1):e==i.GridCellHandle.BottomRight?new N.TheoPoint(1,1):(l.CoreAssert.fail("Incorrect handle type"),new N.TheoPoint(.5,.5))},handlePositions:function(){return[o.positionForHandle(i.GridCellHandle.Top),o.positionForHandle(i.GridCellHandle.Bottom),o.positionForHandle(i.GridCellHandle.Left),o.positionForHandle(i.GridCellHandle.Right)]},handles:function(){return[i.GridCellHandle.Top,i.GridCellHandle.Bottom,i.GridCellHandle.Left,i.GridCellHandle.Right]},cornerHandles:function(){return[i.GridCellHandle.TopLeft,i.GridCellHandle.TopRight,i.GridCellHandle.BottomLeft,i.GridCellHandle.BottomRight]},handleForPosition:function(e){for(var t=a.iter(o.handles());!t.done;t.next()){var r=t.value;if(e.distanceTo(o.positionForHandle(r))<.001)return r}return l.CoreAssert.fail("Incorrect handle position"),null},fromArray:function(e){if(0==e.length||e.length>3)return l.CoreAssert.fail("GridCell.fromArray: Array has incorrect # of elements"),null;var t;if(t=E.TheoRect.decodeJson(a.as(e[0],"AnyObject"))){var r=e[1],n=null;return e.length>2&&(n=a.toString(e[2])),new o(t,n,r)}return null},decodeJson:function(e){return null==e?null:a.is(e,["Array","Any"])?o.fromArray(e):(l.CoreAssert.fail("GridCell: Not an array"),null)}},props:{bounds:{get:function(){return this.region_},set:function(e){this.region_=e}},colorID:{get:function(){return this.colorID_},set:function(e){this.colorID_=e}},opacity:{get:function(){return this.opacity_},set:function(e){this.opacity_=e}},clone:function(){return new o(this.region_,this.colorID_,this.opacity_)},flip:function(){return new o(new E.TheoRect(this.bounds.minY,this.bounds.minX,this.bounds.maxY,this.bounds.maxX),this.colorID_,this.opacity_)},symmetricWith:function(e){var t=this.region_,r=e.bounds;if(t.equal(r))return!1;var o=new N.TheoPoint(1-t.center.x,t.center.y),n=new N.TheoPoint(t.center.x,1-t.center.y);return o.distanceTo(r.center)<.01||n.distanceTo(r.center)<.01},mergeableWith:function(e){var t=this.region_.unionWith(e.bounds);return!(this.region_.L1Distance(e.bounds)>.001)&&_.MathUtils.absDouble(t.area-(this.bounds.area+e.bounds.area))<.01},mergeWith:function(e){l.CoreAssert.isTrue(this.mergeableWith(e),"cell must be adjacent"),this.region_=this.region_.unionWith(e.bounds)},handlePosition:function(e){return this.region_.eval(o.positionForHandle(e))},encode:function(){return l.CoreAssert.fail("GridCell: Use encodeJson(), not encode()"),[]},encodeJson:function(){var e=[];return e.push(this.region_.encodeJson()),l.CoreAssert.isFalse(isNaN(this.opacity),"Can't persist NaN opacity value"),e.push(a.as(this.opacity,"AnyObject")),null!=this.colorID_&&e.push(a.as(this.colorID_,"AnyObject")),a.as(e,"AnyObject")}}}),o),i.PROPERTY_FORMA_MAPPING="forma-mapping",i.GridController=(n=function(e,t,r){this.moveableInitState_=[],this.imageInitState_={},this.checkFramesForCropping_=[],this.gridBounds_=new E.TheoRect(0,0,1,1),b.GroupController.call(this,e,t,r)},a.defineClass({name:"GridController",ctor:n,superName:"GroupController",statics:{KIND:{get:function(){return"grid"}},MAX_CELL_COUNT:{get:function(){return 16}},MIN_CELL_DIM:{get:function(){return 75}},isBackgroundColoredCell:function(e){return e.isGridCell()&&e instanceof A.ShapeForma&&null!=e.controller&&!e.controller.floating},hasLayoutPadding:function(e){var t,r=!1;return(t=a.as(a.opt(e.parent,function(e){return e.controller}),n))&&(r=t.margin>0||t.spacing>0),r}},props:{gridForma:{get:function(){return this.forma}},gridStyle:{get:function(){return a.as(a.opt(this.forma,function(e){return e.style}),S.GridStyle)},set:function(e){var t=this;a.opt(e,function(e){return e.forma=t.forma}),a.opt(this.forma,function(t){return t.protectedSetStyle(e)})}},gridCells:{get:function(){return this.gridStyle.gridCells}},backgroundGridCells:{get:function(){return this.gridStyle.nonOverlappingCells()}},foregroundGridCells:{get:function(){return this.gridStyle.overlappingCells()}},formaMapping:{get:function(){return this.gridStyle.formaMapping}},formaMappingSwiftDict:{get:function(){for(var e={},t=a.iter(a.keys(this.formaMapping));!t.done;t.next()){var r=t.value;e[r]=this.formaMapping[r]}return e}},formaMappingDeepCopy:{get:function(){for(var e={},t=a.iter(a.keys(this.formaMapping));!t.done;t.next()){var r=t.value,o=this.formaMapping[r];e[r]=o.clone()}return e}},selectable:{get:function(){return!0}},moveable:{get:function(){return!1}},rotateable:{get:function(){return!1}},maxMargin:{get:function(){for(var e,t=this.forma.bounds,r=this.forma.finalFrame,o=null,n=a.iter(this.backgroundGridCells);!n.done;n.next()){var i=n.value,l=t.evalRect(i.bounds).transform(this.forma.totalPlacement);o=null==o?l:a.opt(o,function(e){return e.unionWith(l)})}return(e=o)?Math.max(_.MathUtils.absDouble(r.minX-e.minX),_.MathUtils.absDouble(r.maxX-e.maxX),_.MathUtils.absDouble(r.minY-e.minY),_.MathUtils.absDouble(r.maxY-e.maxY)):0}},margin:{get:function(){for(var e=this.forma.bounds,t=this.forma.finalFrame,r=Math.max(t.width,t.height),o=a.iter(this.backgroundGridCells);!o.done;o.next()){var n=o.value,i=e.evalRect(n.bounds).transform(this.forma.totalPlacement),l=Math.min(_.MathUtils.absDouble(t.minX-i.minX),_.MathUtils.absDouble(t.maxX-i.maxX),_.MathUtils.absDouble(t.minY-i.minY),_.MathUtils.absDouble(t.maxY-i.maxY));r=Math.min(r,l)}return r},set:function(e){this.setMargin(e)}},setMargin:function(e,t){void 0===t&&(t=!0);var r=this.margin;if(e!=r){var o=this.forma.bounds.transform(this.forma.totalPlacement),i=this.gridStyle.clone();0==r&&!this.isBackgroundVisible()&&t&&this.setContrastingGridBackgroundColor();for(var l=!0,s=(o.width-2*e)/o.width,u=(o.height-2*e)/o.height,c=e/o.width,h=e/o.height,d=(o.width-2*r)/o.width,m=(o.height-2*r)/o.height,f=r/o.width,p=r/o.height,g=a.iter(this.backgroundGridCells);!g.done;g.next()){var v=(b=g.value).bounds.offsetXY(-f,-p).multiplyXY(1/d,1/m);b.bounds=v.multiplyXY(s,u).offsetXY(c,h)}for(var C=a.iter(this.backgroundGridCells);!C.done;C.next()){var b=C.value,F=this.getCellRegion(b);Math.min(F.width,F.height)<n.MIN_CELL_DIM&&(l=!1)}l?(this.resetMoveableFormaToInitialSizes(),this.layoutGrid(this.gridStyle.moveableShift,null,a.clone(this.preUpdateMapping_),this.preUpdateSpacing_)):this.gridStyle=a.as(i,S.GridStyle)}},getLogos:function(){return this.moveableFormae().filter(function(e){return e.isLogo()},this)},setMarginAndSpacing:function(e,t){t>=0&&(this.margin=t),e>=0&&(this.spacing=e)},linkedFormaForChild:function(e,t){var r=a.clone(this.forma.visitAsArray(f.FormaTraversal.JustChildren));if(a.remove(r,e),this.owner.interactionMode==d.InteractionMode.AutomaticGrid){if(e.isShape()||e.isBackgroundImage())return r}else if(e.isShape()||e.isImage())return e.controller.moveable?this.moveableFormae():this.forma.filterWithCallback(function(t){return(t.isBackgroundImage()||t.isShape())&&null!=t.controller&&!a.eq(f._equality_Forma_Forma,t,e)});return[]},isBackgroundVisible:function(){if(this.gridStyle.spacing>0)return!0;for(var e=1,t=0,r=1,o=0,n=a.clone(this.backgroundGridCells),i=a.iter(n);!i.done;i.next()){var l=i.value;e=Math.min(e,l.bounds.minX),t=Math.max(t,l.bounds.maxX),r=Math.min(r,l.bounds.minY),o=Math.max(o,l.bounds.maxY)}return e>0||r>0||t<1||o<1},styleChanged:function(){var e=this;a.opt(this.gridStyle,function(t){return t.forma=e.forma})},getBoundaryCells:function(e){return this.filterBoundaryCells(a.clone(this.backgroundGridCells),e)},filterBoundaryCells:function(e,t){for(var r=[],o=a.iter(e);!o.done;o.next()){for(var n=o.value,l=!0,s=a.iter(e);!s.done;s.next()){var u=s.value;n!=u&&(t==i.GridCellHandle.Left&&u.bounds.maxX-.01<=n.bounds.minX&&(l=!1),t==i.GridCellHandle.Right&&u.bounds.minX+.01>=n.bounds.maxX&&(l=!1),t==i.GridCellHandle.Top&&u.bounds.maxY-.01<=n.bounds.minY&&(l=!1),t==i.GridCellHandle.Bottom&&u.bounds.minY+.01>=n.bounds.maxY&&(l=!1))}l&&r.push(n)}return r},filterCellsByDirection:function(e,t,r){l.CoreAssert.isTrue(["vertical","horizontal"].includes(r));for(var o=[],n=a.iter(t);!n.done;n.next()){var i=n.value;"horizontal"==r?a.toDouble(Math.round(1e3*Math.max(e.bounds.minY,i.bounds.minY))/1e3)<a.toDouble(Math.round(1e3*Math.min(e.bounds.maxY,i.bounds.maxY))/1e3)&&o.push(i):"vertical"==r&&a.toDouble(Math.round(1e3*Math.max(e.bounds.minX,i.bounds.minX))/1e3)<a.toDouble(Math.round(1e3*Math.min(e.bounds.maxX,i.bounds.maxX))/1e3)&&o.push(i)}return o},spacing:{get:function(){return this.gridStyle.spacing},set:function(e){var t=this.gridStyle.spacing;if(t!=e){0!=t||this.isBackgroundVisible()||this.setContrastingGridBackgroundColor(),this.gridStyle.spacing=e;for(var r=a.iter(this.gridCells);!r.done;r.next()){var o=r.value,i=this.getCellRegion(o);if(Math.min(i.width,i.height)<n.MIN_CELL_DIM)return void(this.gridStyle.spacing=t)}this.resetMoveableFormaToInitialSizes(),this.layoutGrid(this.gridStyle.moveableShift,null,a.clone(this.preUpdateMapping_),this.preUpdateSpacing_)}}},setContrastingGridBackgroundColor:function(){for(var e=this.forma.page.colorLibraryController,t=e.getThemeColorKeys().concat(s.ColorLibraryController.THEME_DERIVED_BW_KEYS),r=[],o=a.iter(this.gridCells.concat());!o.done;o.next()){var n,i=o.value;null!=this.backgroundShapeFormaForCell(i)&&null!=i.colorID&&(t.includes(i.colorID)&&a.remove(t,i.colorID),(n=e.getSolidColorForKey(i.colorID))&&r.push(n),l.CoreAssert.isTrue(null!=e.getSolidColorForKey(i.colorID),"why is the grid color nil??"))}0==(t=t.filter(function(t){var o=e.getSolidColorForKey(t);if(null==o)return!1;for(var n=o,i=a.iter(r);!i.done;i.next()){var l=i.value;if(!n.contrasts(l,!1))return!1}return!0},this)).length&&(t=this.forma.page.colorLibraryController.getThemeColorKeys().concat(s.ColorLibraryController.THEME_DERIVED_BW_KEYS));var u=this.forma.root.style.colors.colorID(h.ColorRole.FieldPrimary);if(null==u||!t.includes(u)){var c=t[_.CoreRandom.nextIntUniform(t.length)];this.forma.root.style.colors.setColorId(h.ColorRole.FieldPrimary,c)}},showHandle:function(e){for(var t=0,r=a.iter(this.gridCells);!r.done;r.next())t+=r.value.bounds.area;return t<.99||b.GroupController.prototype.showHandle.call(this,e)},selectionHandlePositions:{get:function(){for(var e=[],t=a.iter(this.gridCells.concat());!t.done;t.next())for(var r=t.value,o=a.iter(i.GridCell.handles());!o.done;o.next()){var n=o.value,l=r.handlePosition(n);if(this.shouldShowHandle(l,r,n)){for(var s=!1,u=a.iter(e);!u.done;u.next())u.value.distanceTo(l)<.001&&(s=!0);s||e.push(l)}}for(var c=[],h=[],d=a.iter(e);!d.done;d.next()){var m=d.value;if(!h.includes(m)){var f=[];f.push(m);for(var p=a.iter(e);!p.done;p.next()){var g=p.value;m==g||h.includes(g)||this.mergeableHandlePoints(m,g)&&f.push(g)}c.push(this.mergeHandlePoints(a.clone(f)));for(var v=a.iter(f);!v.done;v.next()){var C=v.value;h.push(C)}}}return c}},mergeableHandlePoints:function(e,t){if(e.x==t.x||e.y==t.y){for(var r=new E.TheoRect(e.x,e.y,t.x,t.y).outsetXY(.001,.001),o=a.iter(this.gridCells);!o.done;o.next())if(o.value.bounds.insetRel(.01,.01,.01,.01).intersects(r))return!1;for(var n=a.iter(this.gridCells);!n.done;n.next())if(n.value.bounds.insetRel(.01,.01,.01,.01).intersects(r))return!1;return!0}return!1},mergeHandlePoints:function(e){if(e.length>0){for(var t=e[0].x,r=e[0].x,o=e[0].y,n=e[0].y,i=a.iter(e);!i.done;i.next()){var s=i.value;t=Math.min(t,s.x),r=Math.max(r,s.x),o=Math.min(o,s.y),n=Math.max(n,s.y)}var u=new N.TheoPoint(.5,.5);return a.sort(e,function(e,t){return e.distanceTo(u)<t.distanceTo(u)})[0]}return l.CoreAssert.fail("not enough points"),N.TheoPoint.ZERO},shouldShowHandle:function(e,t,r){for(var o=_.MathUtils.absDouble(e.x)>.01&&_.MathUtils.absDouble(e.y)>.01&&_.MathUtils.absDouble(1-e.x)>.01&&_.MathUtils.absDouble(1-e.y)>.01,n=0,i=a.iter(this.gridCells.concat());!i.done;i.next()){var l=i.value;t!=l&&this.adjacentCellForHandle(t,l,r)&&(n+=1)}return n<=1&&o},adjacentCellForHandle:function(e,t,r){if(e.bounds.L1Distance(t.bounds)>.01)return!1;var o=t.bounds.center.y>=e.bounds.minY&&t.bounds.center.y<=e.bounds.maxY&&e.bounds.height>t.bounds.height+.05,n=t.bounds.center.x>=e.bounds.minX&&t.bounds.center.x<=e.bounds.maxX&&e.bounds.width>t.bounds.width+.05;return!!(r==i.GridCellHandle.Left&&o&&t.bounds.center.x<e.bounds.center.x||r==i.GridCellHandle.Right&&o&&t.bounds.center.x>e.bounds.center.x||r==i.GridCellHandle.Top&&n&&t.bounds.center.y<e.bounds.center.y||r==i.GridCellHandle.Bottom&&n&&t.bounds.center.y>e.bounds.center.y)},getCellBackgroundShape:function(e){var t=this.cellForForma(e);if(null!=t)for(var r=a.iter(this.formaeForCell(t));!r.done;r.next()){var o=r.value;if(o instanceof A.ShapeForma&&n.isBackgroundColoredCell(o))return a.as(o,A.ShapeForma)}return null},getCellBackgroundImage:function(e){if(null!=e.controller&&e.controller.floating)return null;var t=this.cellForForma(e);if(null!=t)for(var r=a.iter(this.formaeForCell(t));!r.done;r.next()){var o,n=r.value;if(n.isBackgroundImage()&&(o=a.as(n,v.FrameForma)))return M.ImageFacade.getImageFormaForForma(o)}return null},childToSelect:function(){var e=a.clone(this.foregroundGridCells);if(0==e.length){var t=new N.TheoPoint(.5,.5);e=a.sort(this.backgroundGridCells,function(e,r){return e.bounds.center.distanceTo(t)<r.bounds.center.distanceTo(t)})}for(var r=a.clone(this.moveableFormae()),o=a.iter(e);!o.done;o.next())for(var n=o.value,i=a.iter(this.formaeForCell(n));!i.done;i.next()){var l=i.value;if(!a.containsEq(r,l,f._equality_Forma_Forma))return l}return this.forma},findCellHandle:function(e){for(var t=a.iter(this.gridCells.concat());!t.done;t.next())for(var r=t.value,o=a.clone(i.GridCell.handlePositions()),n=a.iter(o);!n.done;n.next()){var l=n.value;if(r.bounds.eval(l).distanceTo(e)<.01)return[r,i.GridCell.handleForPosition(l)]}return[null,null]},containsPoint:function(e,t){void 0===t&&(t=0);for(var r=a.iter(this.gridCells.concat());!r.done;r.next()){var o=r.value,n=this.getCellRegion(o);if(0!=t&&(n=n.outsetXY(t,t)),n.containsPoint(e))return!0}return!1},processFormaClick:function(e){a.eq(f._equality_Forma_Forma,e.forma,this.forma)||b.GroupController.prototype.processFormaClick.call(this,e)},beforeProcessFormaDrag:function(e){var t;(t=this.cellForForma(a.first(e.dragDelegate.draggedFormae)))&&(this.dragShapeInitBounds_=t.bounds),this.geomEventAroundChildDrag=new C.FormaGeometryChangedEvent(this.forma),this.forma.beginUpdate(this.geomEventAroundChildDrag)},processFormaDrag:function(e){this.beforeProcessFormaDrag(e),b.GroupController.prototype.processFormaDrag.call(this,e),this.afterProcessFormaDrag(e)},afterProcessFormaDrag:function(e){this.processChildFormaDrag(a.first(e.dragDelegate.draggedFormae),e),this.forma.endUpdate(this.geomEventAroundChildDrag),this.geomEventAroundChildDrag=null},processChildFormaDrag:function(e,t){if(e.controller.kind!=n.KIND){var r=this.cellForForma(e);if(null!=r&&e.kind==A.ShapeForma.KIND&&n.isBackgroundColoredCell(e)&&this.foregroundGridCells.includes(r)&&null!=this.dragShapeInitBounds_){var o=this.forma.finalFrame,i=e.finalFrame,l=-1*Math.min(0,i.minX-o.minX),s=-1*Math.min(0,i.minY-o.minY);i.maxX>o.maxX&&(l=o.maxX-i.maxX),i.maxY>o.maxY&&(s=o.maxY-i.maxY),e.move(k.Matrix2D.translationXY(l,s)),i=e.finalFrame,r.bounds=E.TheoRect.fromXXYY((i.minX-o.minX)/o.width,(i.maxX-o.minX)/o.width,(i.minY-o.minY)/o.height,(i.maxY-o.minY)/o.height);for(var u=r.bounds.origin.subtract(this.dragShapeInitBounds_.origin),c=a.clone(this.moveableFormae()),h=a.iter(this.formaeForCell(r));!h.done;h.next()){var d=h.value;a.containsEq(c,d,f._equality_Forma_Forma)&&d.move(k.Matrix2D.translationXY(u.x*o.width,u.y*o.height))}}}},processChildBeginFormaDrag:function(e,t){this.inferGridCellAssignment()},processEndFormaDrag:function(e){b.GroupController.prototype.processEndFormaDrag.call(this,e),this.processChildEndFormaDrag(e)},afterProcessEndFormaDrag:function(e){this.processChildEndFormaDrag(e)},processChildEndFormaDrag:function(e){this.dragShapeInitBounds_=null,this.inferGridCellAssignment(),a.first(e.dragDelegate.draggedFormae).isTypeLockup()&&this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&this.setInitialFormaSizes()},updateInitStateForForma:function(e){for(var t=a.iter(a.range(0,this.moveableInitState_.length,!1));!t.done;t.next()){var r=t.value,o=this.moveableInitState_[r];if(a.eq(f._equality_Forma_Forma,o.forma,e)){if(this.moveableInitState_[r]=m.DesignSuggestion.init_a05b(e),null==this.preUpdateMapping_)continue;for(var n=[],i=a.iter(a.keys(this.preUpdateMapping_));!i.done;i.next()){var l=i.value;(h=this.preUpdateMapping_[l])&&n.push(h)}for(var s=null,u=a.iter(n);!u.done;u.next()){var c,h=u.value,d=this.getCellRegion(h,this.forma.bounds),p=e.finalFrame;(c=d.intersectionWith(p))&&c.area/p.area>.8&&(s=h,this.preUpdateMapping_[e.formaID]=h)}null==s?null!=this.preUpdateMapping_[e.formaID]&&a.removeKey(this.preUpdateMapping_,e.formaID):this.preUpdateMapping_[e.formaID]=s}}},isChildSwappable:function(e){var t;return(t=a.as(e,T.ImageForma))?this.isChildSwappable(t.parent):null!=e.controller&&!e.controller.moveable},swapGridChildren:function(e,t){var r,o;this.isChildSwappable(e)&&this.isChildSwappable(t)&&(r=this.cellForForma(e))&&(o=this.cellForForma(t))&&this.swapCells(r,o)},swapCells:function(e,t){var r=t.colorID;t.colorID=e.colorID,e.colorID=r;for(var o=[],n=[],i=a.iter(this.formaMappingSwiftDict);!i.done;i.next()){var l=i.key,s=i.value;s==e&&o.push(l),s==t&&n.push(l)}for(var u=a.iter(o);!u.done;u.next())l=u.value,this.formaMapping[l]=t;for(var c=a.iter(n);!c.done;c.next())l=c.value,this.formaMapping[l]=e;var h=null;this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&(this.resetMoveableFormaToInitialSizes(),h=a.clone(this.preUpdateMapping_)),this.layoutGrid(this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&this.gridStyle.moveableShift,null,a.clone(h));for(var m=a.iter(o);!m.done;m.next())l=m.value,t.bounds.area<e.bounds.area/2&&(g=a.as(a.opt(this.forma.formaByID(l),function(e){return e.controller}),p.FrameController))&&g.cropSizeCheck();for(var f=a.iter(n);!f.done;f.next()){var g;l=f.value,e.bounds.area<t.bounds.area/2&&(g=a.as(a.opt(this.forma.formaByID(l),function(e){return e.controller}),p.FrameController))&&g.cropSizeCheck()}},spacingChangesVisible:{get:function(){return this.gridStyle.numBackgroundCells>1}},enterLayoutMode:function(){this.setInitialFormaSizes(),this.inferGridCellAssignment(),this.updateGridColors()},setInitialFormaSizes:function(){l.CoreAssert.isTrue(null!=this.gridStyle.forma),this.preUpdateMapping_=a.clone(this.formaMappingDeepCopy),this.preUpdateSpacing_=this.gridStyle.spacing,this.moveableInitState_.forEach(function(e){return e.dispose()}),this.moveableInitState_=[];for(var e=a.iter(this.moveableFormae());!e.done;e.next()){var t,r=e.value;(t=a.as(r.controller,B.TypeLockupController))&&t.centerAlignmentIfSingleLine(),this.moveableInitState_.push(m.DesignSuggestion.init_a05b(r))}},onFormaeDeleted:function(e){for(var t=a.iter(e);!t.done;t.next())for(var r=t.value,o=a.iter(a.toSequence(this.moveableInitState_));!o.done;o.next()){var n=o.value,i=n.offset,l=n.element;if(a.eq(f._equality_Forma_Forma,l.forma,r)){l.dispose(),this.moveableInitState_.splice(i,1);break}}},beginChildResizeEvent:function(e){this.setImageInitialSizes()},setImageInitialSizes:function(){this.imageInitState_={};for(var e=a.iter(this.forma.visitAsArray(f.FormaTraversal.PreOrder));!e.done;e.next()){var t=e.value;null!=t.controller&&t.controller.moveable&&t.kind==T.ImageForma.KIND&&(this.imageInitState_[t.formaID]=t.placement)}},resetMoveableFormaToInitialSizes:function(){if(!this.blockUpdate)for(var e=a.iter(this.moveableInitState_);!e.done;e.next()){var t=e.value,r=t.forma.style.colors.colorID(h.ColorRole.FieldPrimary),o=t.forma.style.colors.colorID(h.ColorRole.FieldSecondary);t.apply(),t.forma.style.colors.setColorId(h.ColorRole.FieldPrimary,r),t.forma.style.colors.setColorId(h.ColorRole.FieldSecondary,o)}},resetImageFormaToInitialPlacement:function(){for(var e=a.iter(this.forma.visitAsArray(f.FormaTraversal.PreOrder));!e.done;e.next()){var t,r=e.value;(t=this.imageInitState_[r.formaID])&&(r.placement=t)}},currentResizeCellHandlePosition:function(){return null!=this.resizeCell_?this.resizeCell_.handlePosition(this.resizeCellHandle_):null},clone:function(e){return new g.FormaControllerFactory(this.owner).createController(this.kind,e)},postClone:function(e){var t,r;(t=a.as(e.controller,n))&&(r=t.gridStyle)&&(e.style.forma=e,a.opt(this.gridStyle,function(e){return e.postCloneMatch(r)}))},contentID:{get:function(){return"grid"}},mappedFormaIDs:function(){return l.CoreAssert.isFalse(a.keys(this.formaMapping).includes(this.forma.formaID),"should be returning the grid id"),a.keys(this.formaMapping)},matchImageStyles:function(e){for(var t=a.clone(this.forma.filterWithCallback(function(e){return e.kind==T.ImageForma.KIND&&e.parent.isBackgroundImage()})),r=a.clone(e.forma.filterWithCallback(function(e){return e.kind==T.ImageForma.KIND&&e.parent.isBackgroundImage()})),o=a.iter(a.range(0,t.length,!1));!o.done;o.next()){var n=o.value;t[n].match(r[n%r.length])}},match:function(e){this.beginBlockedUpdate(),this.forma.bounds=e.forma.bounds,this.endBlockedUpdate();var t,r=this.forma.filterWithCallback(function(e){return e.isBackgroundImage()}).length,o=e.forma.filterWithCallback(function(e){return e.isBackgroundImage()}).length,i=this.forma.filterWithCallback(function(e){return n.isBackgroundColoredCell(e)}).length,l=e.forma.filterWithCallback(function(e){return n.isBackgroundColoredCell(e)}).length;if(t=a.as(e,n)){r>0&&o>0&&this.matchImageStyles(e);var s=this.gridStyle;if(o<=r){this.splitCellsWithMultipleBackgroundImages(null);var u=0==l&&1==o&&t.maxMargin<10,c=1==l&&0==o&&t.maxMargin<10;(i>0&&(u||c)&&0==s.overlappingCells().length||r+o==0&&l<=1)&&(0==o&&0==r&&1==t.gridStyle.numCells?this.gridCells[0].colorID=t.gridStyle.gridCells[0].colorID:this.recreateGrid(!1,Math.max(r,1),!1)),Math.abs(t.margin-t.maxMargin)<1&&(this.margin=t.margin)}else if(r<o){for(var h=a.clone(a.shuffle(this.forma.page.colorLibraryController.getThemeColorKeys())),d=[],m=a.iter(this.gridStyle.gridCells);!m.done;m.next())null==(C=m.value).colorID||d.includes(C.colorID)||d.push(C.colorID);if(o-r<h.length-d.length)for(var f=a.iter(d);!f.done;f.next()){var p=f.value;h.includes(p)&&a.remove(h,p)}for(var g=0,v=a.iter(this.gridCells.concat());!v.done;v.next()){var C=v.value;null!=this.backgroundShapeFormaForCell(C)&&null==C.colorID&&(C.colorID=h[g%h.length],g+=1)}}this.layoutGrid(!1),this.cropCheck()}},postMatch:function(e){this.inferBackgroundCellAssignment()},showChildHandle:function(e,t){var r,o=this.forma.bounds,n=this.forma.finalFrame;if((r=this.cellForForma(e))&&this.gridStyle.overlappingCells().includes(r)&&n.equalWithAccuracy(e.finalFrame,10))return!0;for(var i=0,l=a.iter(this.backgroundGridCells);!l.done;l.next()){var s=l.value,u=o.evalRect(s.bounds).transform(this.forma.totalPlacement),c=Math.min(_.MathUtils.absDouble(n.minX-u.minX),_.MathUtils.absDouble(n.maxX-u.maxX),_.MathUtils.absDouble(n.minY-u.minY),_.MathUtils.absDouble(n.maxY-u.maxY));i=Math.max(i,c)}var h=e.finalFrame.eval(t);return!(i<.001&&(h.x<5||h.y<5||h.x>e.root.finalFrame.maxX-5||h.y>e.root.finalFrame.maxY-5))},applyGridStyleWithMapping:function(e,t){var r=this.gridStyle,o=this.gridCells.concat(),n=a.clone(this.formaMappingSwiftDict),i=this.margin;r.match(e),this.updateHierarchy(),this.colorGrid(a.clone(o),a.clone(n)),this.layoutGrid(e.moveableShift),this.setInitialFormaSizes(),r.cropType=p.CropType.PreserveFocus,t&&this.setMargin(i,!1)},applyStyle:function(e,t){var r;if(r=a.as(e,S.GridStyle)){var o;if(this.gridStyle.forma=this.forma,0!=a.count(r.formaMapping)&&0==t)r.spacing=this.gridStyle.spacing,this.applyGridStyleWithMapping(r,!0),o=r;else{var n=null!=this.gridForma.parent&&null!=this.gridForma.root;if(l.CoreAssert.isTrue(n,"bad things are happening. we're apply a style to a forma which is no longer attached"),!n)return;var i=a.clone(r.numCells==this.gridStyle.numCells?this.formaMappingSwiftDict:null),s=a.clone(new I.GridSuggester(this.gridForma,null,r,a.clone(i)).createSuggestions());if(s.length>0){var u=s[t%s.length];u.gridStyle.spacing=this.gridStyle.spacing,this.applyGridStyleWithMapping(u.gridStyle,!0),o=u.gridStyle}}null!=o&&o.moveableShift&&this.owner.interactionMode!=d.InteractionMode.DefaultInteraction&&this.adjustLogos(a.clone(this.getLogos())),r.name!=D.GridLibrary.instance.basicFullDesignGridStyle().name&&(this.contrastCheck(),this.cropCheck()),l.CoreAssert.isTrue(null!=this.gridStyle.forma)}},adjustLogos:function(e){for(var t=a.iter(e);!t.done;t.next()){var r,o=t.value;(r=a.as(o.controller,p.FrameController))&&r.placeAsLogo()}},numCells:{get:function(){return this.gridCells.length}},contrastCheck:function(){for(var e=a.iter(this.moveableFormae());!e.done;e.next()){var t,r=e.value;a.keys(this.formaMapping).includes(r.formaID)&&(t=this.cellForForma(r))&&this.backgroundShapeFormaForCell(t)&&a.opt(r.controller,function(e){return e.contrastCheck(!1)})}},cropCheck:function(){for(var e=a.iter(this.checkFramesForCropping_);!e.done;e.next()){var t,r=e.value;(t=a.as(r.controller,p.FrameController))&&t.cropSizeCheck()}},replaceChildWithForma:function(e,t,r){void 0===r&&(r=!1);var o,n,i=this.isReplacedWithSameImage(e,t);if(b.GroupController.prototype.replaceChildWithForma.call(this,e,t,r),e.controller.floating){var l=e.placement.transformValues,s=t.finalFrame.center;t.placement=t.placement.rotateTo(l.rotCosine,l.rotSine),t.moveCenterToPoint(s)}if((o=this.cellForForma(e))&&(a.removeKey(this.formaMapping,e.formaID),this.formaMapping[t.formaID]=o,t.isShape())){var u,c,h=this.forma.page.colorLibraryController;(u=this.getContrastingColorForCell(t))&&null!=(c=h.getKeyOfColorInTheme(u))&&(o.colorID=c)}(n=a.as(t.controller,p.FrameController))&&(i||e.controller.floating||n.fitWithCrop(t.frame,p.CropType.FitBorder)),i||e.controller.floating||this.layoutGrid(!1)},isReplacedWithSameImage:function(e,t){var r=a.clone(t.filterByKind(T.ImageForma.KIND)),o=a.clone(e.filterByKind(T.ImageForma.KIND));if(r.length>0&&o.length>0)for(var n=a.iter(r);!n.done;n.next()){var i,l,s=n.value,u=o[0];if((i=a.opt(s.contentNode,function(e){return e.mediaMetadata}))&&(l=a.opt(u.contentNode,function(e){return e.mediaMetadata})))return null!=i.assetID&&null!=l.assetID&&i.assetID==l.assetID}return!1},removeFormaFromGroup:function(e){var t;if(b.GroupController.prototype.removeFormaFromGroup.call(this,e),this.forma instanceof y.GroupForma&&(t=this.formaMapping[e.formaID])){if(a.removeKey(this.formaMapping,e.formaID),e.controller.floating)return;var r=!1;if(e.controller.moveable){for(var o=a.iter(this.formaeForCell(t));!o.done;o.next())c=o.value,a.removeKey(this.formaMapping,c.formaID);a.remove(this.gridCells,t)}else{for(var n=a.iter(this.gridCells.concat());!n.done;n.next()){var s=n.value;if(s!=t&&s.mergeableWith(t)){s.mergeWith(t);for(var u=a.iter(this.formaeForCell(t));!u.done;u.next()){var c=u.value;a.removeKey(this.formaMapping,c.formaID)}a.remove(this.gridCells,t),r=!0;break}}if(!r){var d=this.gridStyle.numBackgroundCells;if(d>1){var m=this.getCellRegion(t),f=this.gridForma.frame,p=t.bounds,g=null;if(m.minX>f.minX+this.margin+1&&this.canRemoveFromHandleDirection(t,i.GridCellHandle.Left)?(g=i.GridCellHandle.Left,p=new E.TheoRect(p.maxX,p.minY,p.maxX,p.maxY)):m.maxX<f.maxX-this.margin-1&&this.canRemoveFromHandleDirection(t,i.GridCellHandle.Right)?(g=i.GridCellHandle.Right,p=new E.TheoRect(p.minX,p.minY,p.minX,p.maxY)):m.minY>f.minY+this.margin+1&&this.canRemoveFromHandleDirection(t,i.GridCellHandle.Top)?(g=i.GridCellHandle.Top,p=new E.TheoRect(p.minX,p.maxY,p.maxX,p.maxY)):m.maxY<f.maxY-this.margin-1&&this.canRemoveFromHandleDirection(t,i.GridCellHandle.Bottom)&&(g=i.GridCellHandle.Bottom,p=new E.TheoRect(p.minX,p.minY,p.maxX,p.minY)),null!=g){this.updateCellRegion(t,p,g,!1);for(var v=a.iter(this.formaeForCell(t));!v.done;v.next()){var c=v.value;a.removeKey(this.formaMapping,c.formaID)}a.remove(this.gridCells,t)}}else if(1==d){var C;null!=(C=a.opt(a.opt(this.forma,function(e){return e.root}),function(e){return e.style.colors.colorID(h.ColorRole.FieldPrimary)}))&&(this.gridStyle.gridCells[0].colorID=C,this.margin=0)}else l.CoreAssert.fail("Should have at least one background cell. Something is wrong.")}this.layoutGrid(!1)}this.preUpdateMapping_=a.clone(this.formaMappingDeepCopy)}},canRemoveFromHandleDirection:function(e,t){for(var r=a.iter(this.gridCells.concat());!r.done;r.next()){var o=r.value;if(o!=e&&0==e.bounds.L1Distance(o.bounds)){var n=e.bounds.unionWith(o.bounds);if(t==i.GridCellHandle.Left&&e.bounds.minX==o.bounds.maxX&&n.height!=e.bounds.height)return!1;if(t==i.GridCellHandle.Right&&e.bounds.maxX==o.bounds.minX&&n.height!=e.bounds.height)return!1;if(t==i.GridCellHandle.Bottom&&e.bounds.minY==o.bounds.maxY&&n.width!=e.bounds.width)return!1;if(t==i.GridCellHandle.Top&&e.bounds.maxY==o.bounds.minY&&n.width!=e.bounds.width)return!1}}return!0},setupWithFormae:function(e){var t;if(t=a.as(this.forma,y.GroupForma)){t.removeAllChildren();for(var r=a.iter(e);!r.done;r.next()){var o=r.value;t.appendChild(o)}this.recreateGrid()}},inferGridCellAssignment:function(e){void 0===e&&(e=null);var t,r=null!=e?e:a.opt(this.forma,function(e){return e.bounds});if(t=r)for(var o=a.iter(this.moveableFormae());!o.done;o.next()){for(var n=o.value,i=null,l=a.iter(this.gridCells.concat());!l.done;l.next()){var s,u,c=l.value,h=this.getCellRegion(c,t);(s=a.opt(n.frame,function(e){return e.intersectionWith(r)}))&&(u=h.intersectionWith(s))&&u.area/s.area>.85&&(i=c,this.formaMapping[n.formaID]=c)}null==i&&null!=this.formaMapping[n.formaID]&&a.removeKey(this.formaMapping,n.formaID)}},addFormaToGroup:function(e){var t,r=this;if(l.CoreAssert.isTrue(null!=this.gridStyle.forma),t=a.as(this.forma,y.GroupForma)){t.insertChildAt(e,0,!1);var o=a.clone(t.visitAsArray(f.FormaTraversal.JustChildren)),i=e.isImage()&&!e.controller.floating,s=null,u=null;if(this.owner.selection.forEachSelected(function(e){n.isBackgroundColoredCell(e)&&e.parent==r.forma&&(s=r.cellForForma(e),u=e)}),null!=u&&this.owner.selection.deselectForma(u),null==s)for(var c=a.iter(this.backgroundGridCells);!c.done;c.next()){for(var h=c.value,d=!1,m=a.iter(o);!m.done;m.next()){var p=m.value;this.formaMapping[p.formaID]==h&&p.isBackgroundImage()&&(d=!0)}if(!d){s=h;break}d==i&&(null==s||s.bounds.area<h.bounds.area)&&(s=h)}this.formaMapping[e.formaID]=null!=s?s:this.gridCells[0],this.splitCellsWithMultipleBackgroundImages(e),this.layoutGrid(!1)}},createBasicGrid:function(){var e=this.gridCells[0].colorID,t=[];t.push(new i.GridCell(new E.TheoRect(0,0,1,1),e)),this.gridStyle.gridCells=t;for(var r=a.iter(this.forma.visitAsArray(f.FormaTraversal.JustChildren));!r.done;r.next()){var o=r.value;o.isBackgroundImage()&&(this.formaMapping[o.formaID]=this.gridCells[0])}this.splitCellsWithMultipleBackgroundImages(null)},splitCellsWithMultipleBackgroundImages:function(e){var t;if((t=a.as(this.forma,y.GroupForma))&&t.bounds){for(var r=a.clone(t.visitAsArray(f.FormaTraversal.JustChildren)),o=[],n=a.iter(this.backgroundGridCells);!n.done;n.next()){for(var l=n.value,s=[],u=0,c=a.iter(r);!c.done;c.next()){var h=c.value;this.formaMapping[h.formaID]==l&&h.isBackgroundImage()&&(u+=1,s.push(h))}if(u>1){var d=a.indexOf(this.gridCells,l),m=this.getCellRegion(l),p=m.width,g=m.height,C=l.bounds,b=p/g>=1;b?p/=a.toDouble(u):g/=a.toDouble(u);var F=u%2==0&&u>2;if(F){var D=Math.max(p/g,g/p),I=p,S=g;b?(I=m.width/a.toDouble(a.toInt(u/2)),S=m.height/2):(I=m.width/2,S=m.height/a.toDouble(a.toInt(u/2))),Math.max(I/S,S/I)<D?(p=I,g=S):F=!1}for(var x=a.toInt(m.width/p),T=a.toInt(m.height/g),P=0,k=a.repeat(a.repeat(1,T),x),_=a.iter(a.range(0,x,!1));!_.done;_.next())for(var G=_.value,w=a.iter(a.range(0,T,!1));!w.done;w.next()){var A,R,B,N=w.value,L=m.aspectRatio;a.eq(f._equality_Forma_Forma,s[P],e)&&(A=a.as(s[P],v.FrameForma))&&(R=M.ImageFacade.getImageFormaForForma(A))&&(B=R.bounds)&&(L=B.aspectRatio),k[G][N]=b?L:1/L,P+=1}if(P=0,F)for(var Y=a.toDouble(l.bounds.width)/a.toDouble(x),U=a.toDouble(l.bounds.height)/a.toDouble(T),X=a.iter(a.range(0,x,!1));!X.done;X.next()){G=X.value;for(var H=a.iter(a.range(0,T,!1));!H.done;H.next()){N=H.value;var K=new E.TheoRect(C.minX+a.toDouble(G)*Y,C.minY+a.toDouble(N)*U,C.minX+a.toDouble(G+1)*Y,C.minY+a.toDouble(N+1)*U),O=new i.GridCell(K,l.colorID);this.formaMapping[s[P].formaID]=O,P+=1,this.gridCells.splice(d,0,O)}}else for(var z=[],W=[],q=[],J=[],j=a.iter(a.range(0,x,!1));!j.done;j.next()){G=j.value,z=a.clone(k[G]),J=a.clone(m.split(k[G].length,b,a.clone(z)));for(var V=a.iter(a.range(0,T,!1));!V.done;V.next()){if(N=V.value,x>0&&0==N){W.splice(0);for(var Z=a.iter(a.range(0,x,!1));!Z.done;Z.next()){var Q=Z.value;W.push(k[Q][N])}q=a.clone(m.split(W.length,b,a.clone(W)))}if(J.length>1){var $=m.locatePoint(J[N].evalXY(0,0)),ee=m.locatePoint(J[N].evalXY(1,1));K=C.evalUUVV($.x,ee.x,$.y,ee.y),O=new i.GridCell(K,l.colorID),this.formaMapping[s[P].formaID]=O,P+=1,this.gridCells.splice(d,0,O)}}q.length>1&&($=m.locatePoint(q[G].evalXY(0,0)),ee=m.locatePoint(q[G].evalXY(1,1)),K=C.evalUUVV($.x,ee.x,$.y,ee.y),O=new i.GridCell(K,l.colorID),this.formaMapping[s[P].formaID]=O,P+=1,this.gridCells.splice(d,0,O))}o.push(l)}}for(var te=a.iter(o);!te.done;te.next())l=te.value,a.remove(this.gridCells,l)}},shouldRecreateGrid:function(e){var t,r,o;if((t=a.opt(this.forma,function(e){return e.root}))&&t.isModel)return!1;if(this.gridStyle.anyOverlap)return!1;if(1==this.gridCells.length)return!1;if(this.gridCells.length>4)return!1;if((r=a.as(this.forma,y.GroupForma))&&(o=r.bounds)){if(o.similarity(e)<.1)return!1;var n=!1,i=o.aspectRatio>1?o.width/a.toDouble(this.gridCells.length)/o.height:o.height/a.toDouble(this.gridCells.length)/o.width;if(i=Math.max(i,1/i),this.gridCells.length%2==0){var l=0,s=0;o.aspectRatio>1?(l=o.width/a.toDouble(a.toInt(this.gridCells.length/2)),s=o.height/2):(l=o.width/2,s=o.height/a.toDouble(a.toInt(this.gridCells.length/2)));var u=Math.max(l/s,s/l);u<i&&(i=u)}for(var c=a.iter(this.gridCells.concat());!c.done;c.next()){var h=c.value,d=e.evalRect(h.bounds).aspectRatio;d=Math.max(d,1/d);var m=o.evalRect(h.bounds).aspectRatio;(m=Math.max(m,1/m))-d>=2&&m-i>=1&&(n=!0)}return n}return!1},recreateGrid:function(e,t,r){void 0===e&&(e=!0),void 0===t&&(t=null),void 0===r&&(r=!0),this.assertCorrectLayout();var o=this.forma.filterWithCallback(function(e){return e.kind==T.ImageForma.KIND&&e.parent.isBackgroundImage()}).length,n=null!=t?t:Math.max(o,this.gridCells.length),i=a.clone(D.GridLibrary.instance.getGridsByCellNumber(n,!1));if(n==this.gridCells.length){var s=a.opt(this.gridStyle,function(e){return e.clone()});i.push(s.flipRegion())}for(var u=m.DesignSuggestion.init_a05b(this.forma.root),c=this.spacing,h=[],d=a.iter(i);!d.done;d.next()){var f=d.value;f.moveableShift=e;var p=a.clone(r?this.formaMappingSwiftDict:null);a.append(h,new I.GridSuggester(this.forma,u,f,a.clone(p)).createSuggestions())}if(h.length>0){a.sortInPlace(h,function(e,t){return e.score>t.score});var g=h[0];l.CoreAssert.isTrue(g.gridStyle.moveableShift==e,"moveable shift failing"),g.gridStyle.spacing=c,this.applyGridStyleWithMapping(g.gridStyle,!0)}else this.createBasicGrid();u.dispose()},childUpdate:function(e){var t;if(void 0===e&&(e=null),this.updatedChild=e,null!=e&&null==this.dragShapeInitBounds_&&this.isGridCell(e)&&(t=e)){this.owner.interactionMode!=d.InteractionMode.AutomaticGrid&&this.updateGridAssignments(),this.updateGridColors();var r=this.cellForForma(t);if(null==r)return void l.CoreAssert.warning("Couldn't match cell");var o=this.updatedCellBounds(t,r,!1),n=null;if(_.MathUtils.absDouble(r.bounds.minX-o.minX)>.001?n=i.GridCellHandle.Left:_.MathUtils.absDouble(r.bounds.maxX-o.maxX)>.001?n=i.GridCellHandle.Right:_.MathUtils.absDouble(r.bounds.minY-o.minY)>.001?n=i.GridCellHandle.Top:_.MathUtils.absDouble(r.bounds.maxY-o.maxY)>.001&&(n=i.GridCellHandle.Bottom),null!=n){o=this.updatedCellBounds(t,r,!0),this.updateCellRegion(r,o,n,!0);var s=null;this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&(0==this.moveableInitState_.length&&this.setInitialFormaSizes(),this.resetMoveableFormaToInitialSizes(),s=a.clone(this.preUpdateMapping_)),this.resetImageFormaToInitialPlacement(),this.layoutGrid(this.owner.interactionMode==d.InteractionMode.AutomaticGrid,null,a.clone(s))}}},getAdjustedSpacingsForCell:function(e,t){var r=a.clone(this.backgroundGridCells),o=a.clone(this.filterCellsByDirection(e,a.clone(r),"horizontal")),n=a.clone(this.filterCellsByDirection(e,a.clone(r),"vertical"));o=a.sort(o,function(e,t){return e.bounds.minX<t.bounds.minX}),n=a.sort(n,function(e,t){return e.bounds.minY<t.bounds.minY}),o=a.clone(this.removeOverlapCells(a.clone(o),"horizontal")),n=a.clone(this.removeOverlapCells(a.clone(n),"vertical"));for(var i=-1,l=-1,s=a.iter(a.range(0,o.length,!1));!s.done;s.next())if(o[c=s.value].bounds.equal(e.bounds)){i=c;break}for(var u=a.iter(a.range(0,n.length,!1));!u.done;u.next()){var c;if(n[c=u.value].bounds.equal(e.bounds)){l=c;break}}var h=t,d=t,m=t,f=t,p=o.length,g=a.toDouble(p-1)/a.toDouble(p);0==i&&(h=0,p>2?d*=g:d/=2),i==p-1&&(d=0,p>2?h*=g:h/=2),p>2&&0!=i&&i!=p-1&&(1==i&&i==p-2?(h*=1-g,d*=1-g):1==i?(h*=1-g,d/=2):i==p-2?(d*=1-g,h/=2):(h/=2,d/=2));var v=n.length,C=a.toDouble(v-1)/a.toDouble(v);return 0==l&&(m=0,v>2?f*=C:f/=2),l==v-1&&(f=0,v>2?m*=C:m/=2),v>2&&0!=l&&l!=v-1&&(1==l&&l==v-2?(m*=1-C,f*=1-C):1==l?(m*=1-C,f/=2):l==v-2?(f*=1-C,m/=2):(m/=2,f/=2)),[h,d,m,f]},updatedCellBounds:function(e,t,r){var o=this.forma.finalFrame,n=r?e.finalFrame.intersectionWith(o):e.finalFrame,i=this.gridStyle.overlappingCells().includes(t)?0:this.gridStyle.spacing,l=a.clone(this.getAdjustedSpacingsForCell(t,i)),s=l[0],u=l[1],c=l[2],h=l[3],d=new E.TheoRect(n.minX-s,n.minY-c,n.maxX+u,n.maxY+h);return new E.TheoRect((d.minX-o.minX)/o.width,(d.minY-o.minY)/o.height,(d.maxX-o.minX)/o.width,(d.maxY-o.minY)/o.height)},updateCellRegion:function(e,t,r,o){if(void 0===o&&(o=!0),null!=a.as(this.forma,y.GroupForma)){var l=e.bounds,s=null,u=null,c=null;r==i.GridCellHandle.Left?(s=l.verticalLine(0),u=t.minX):r==i.GridCellHandle.Right?(s=l.verticalLine(1),u=t.maxX):r==i.GridCellHandle.Top?(s=l.horizontalLine(0),c=t.minY):r==i.GridCellHandle.Bottom&&(s=l.horizontalLine(1),c=t.maxY);var h=this.getCellRegion(e,null,t);if(o&&Math.min(h.width,h.height)<n.MIN_CELL_DIM)return a.opt(x.Host.logging,function(e){return e.info("new cell too small")}),!1;if(null!=u&&(u<0||u>1)||null!=c&&(c<0||c>1))return a.opt(x.Host.logging,function(e){return e.info("shifted out of bounds  "+l.asString+" -> "+t.asString)}),!1;var d=[],m=[];if(d.push({cell:e,bounds:t}),m.push({cell:e,bounds:e.bounds}),null!=s&&this.gridStyle.nonOverlappingCells().includes(e))for(var f=a.iter(this.gridCells);!f.done;f.next())if((T=f.value)!=e){var p=T.bounds,g=p,v=s.projectionOffset(T.handlePosition(i.GridCellHandle.Left)).length(),C=s.projectionOffset(T.handlePosition(i.GridCellHandle.Right)).length(),b=s.projectionOffset(T.handlePosition(i.GridCellHandle.Top)).length(),F=s.projectionOffset(T.handlePosition(i.GridCellHandle.Bottom)).length();if(null!=u&&(v<C&&v<.02?g=new E.TheoRect(u,p.minY,p.maxX,p.maxY):v>C&&C<.02&&(g=new E.TheoRect(p.minX,p.minY,u,p.maxY))),null!=c&&(F<b&&F<.02?g=new E.TheoRect(p.minX,p.minY,p.maxX,c):F>b&&b<.02&&(g=new E.TheoRect(p.minX,c,p.maxX,p.maxY))),p.minX!=g.minX&&p.maxX!=g.maxX||p.minY!=g.minY&&p.maxY!=g.maxY)return!1;if(h=this.getCellRegion(T,null,g),g.minX<0||g.minY<0||g.maxX>1||g.maxY,o&&Math.min(h.width,h.height)<n.MIN_CELL_DIM)return!1;d.push({cell:T,bounds:g}),m.push({cell:T,bounds:T.bounds})}for(var D=a.clone(this.gridStyle.nonOverlappingCells()),I=a.iter(d);!I.done;I.next())(k=I.value).cell.bounds=k.bounds;for(var S=a.iter(D);!S.done;S.next()){var T=S.value;if(!this.gridBounds_.contains(T.bounds))return a.opt(x.Host.logging,function(e){return e.info("out of bounds "+T.bounds)}),!1;T.bounds.area}if(this.gridStyle.nonOverlappingCells().length!=D.length){for(var M=a.iter(this.gridCells);!M.done;M.next())T=M.value,a.opt(x.Host.logging,function(e){return e.info("gridCell "+T.bounds.asString)});for(var P=a.iter(m);!P.done;P.next()){var k;(k=P.value).cell.bounds=k.bounds}return!1}return!0}return!1},inferBackgroundCellAssignment:function(){for(var e=a.iter(this.gridCells);!e.done;e.next())for(var t=e.value,r=this.getCellRegion(t),o=a.iter(this.forma.visitAsArray(f.FormaTraversal.JustChildren));!o.done;o.next()){var n,i=o.value;(n=i.finalFrame)&&n.equalWithAccuracy(r,.01)&&(i.controller.moveable&&i.kind!=A.ShapeForma.KIND||(this.formaMapping[i.formaID]=t))}},backgroundShapeFormaForCell:function(e,t){void 0===t&&(t=null);for(var r=a.clone(null!=t?t:this.formaMappingSwiftDict),o=a.iter(r);!o.done;o.next()){var n,i=o.key;if(o.value==e&&(n=this.forma.formaByID(i))&&n.kind==A.ShapeForma.KIND&&this.isGridCell(n))return a.as(n,A.ShapeForma)}return null},isGridCell:function(e){if(e.hasIntent(f.Forma.INTENT_GRID_CELL))return!0;if(e.hasIntent(f.Forma.INTENT_ICON)||e.hasIntent(f.Forma.INTENT_FLOATING_SHAPE)||e.hasIntent(f.Forma.INTENT_LOGO))return!1;if(e.parent==this.forma&&(e.isShape()||e.isImage())){var t,r;if((t=a.as(e,A.ShapeForma))&&null==t.contentNode)return!0;if(e.isBackgroundImage())return!0;if(r=e.finalFrame)for(var o=a.iter(this.gridCells);!o.done;o.next()){var n=o.value;if(this.getCellRegion(n).equalWithAccuracy(r,.1))return!0}if(e.kind==y.GroupForma.KIND)return!1;if(null==a.opt(a.as(e,A.ShapeForma),function(e){return e.contentNode})&&e.isShape())return!0}return!1},childMoveableInDirection:function(e,t){if(e.isShape()||e.isImage()){var r,o,n;if((r=this.cellForForma(e))&&this.foregroundGridCells.includes(r)&&(o=e.finalFrame)&&(n=a.opt(this.forma,function(e){return e.finalFrame}))){if(Math.abs(o.width-n.width)<2&&t.x>0)return!1;if(Math.abs(o.height-n.height)<2&&t.y>0)return!1}return null==e.allowUserMove||e.allowUserMove}return!0},formaeForCell:function(e){for(var t=[],r=a.iter(this.formaMappingSwiftDict);!r.done;r.next()){var o,n=r.key;r.value==e&&(o=this.forma.formaByID(n))&&t.push(o)}return t},cellForForma:function(e){return this.formaMapping[e.formaID]},updateGridAssignments:function(){this.forma.bounds;for(var e=a.clone(this.forma.visitAsArray(f.FormaTraversal.JustChildren)),t=a.iter(this.gridCells.concat());!t.done;t.next())for(var r=t.value,o=this.getCellRegion(r),n=this.gridStyle.overlappingCells().includes(r),i=a.iter(e);!i.done;i.next()){var l,s,u=i.value;n&&u.isBackgroundImage()||(l=u.finalFrame)&&(s=l.intersectionWith(o))&&s.area/Math.max(o.area,l.area)>.9&&(this.formaMapping[u.formaID]=r)}},beginUpdateGroup:function(e){void 0===e&&(e=null),b.GroupController.prototype.beginUpdateGroup.call(this,e),this.inferGridCellAssignment()},updateGroup:function(){if(!this.blockUpdate){var e=!1,t=null,r=null;if(null!=this.oldBounds){t=a.clone(this.formaMappingSwiftDict),this.beginBlockedUpdate();var o=this.margin,n=this.maxMargin;r=this.spacing,this.updateGridColors(),this.inferGridCellAssignment(this.oldBounds);for(var i=a.iter(this.moveableFormae());!i.done;i.next()){var l=i.value;(null==this.formaMapping[l.formaID]||this.formaMapping[l.formaID].bounds.equal(E.TheoRect.ONE_BY_ONE))&&(e=!0)}if(e)for(var s=a.iter(this.moveableFormae());!s.done;s.next())l=s.value,a.removeKey(this.formaMapping,l.formaID);!e&&this.shouldRecreateGrid(this.oldBounds)&&this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&this.recreateGrid(),Math.abs(o-n)<50&&(this.margin=.1,this.margin=o),this.endBlockedUpdate()}var u=this.gridStyle.cropType;if(1==this.gridStyle.numBackgroundCells&&"Original"==this.gridForma.page.sizeID){var c,h=a.clone(this.forma.filterWithCallback(function(e){return null!=e.parent&&e.parent.isBackgroundImage()&&e.kind==T.ImageForma.KIND}));1==h.length&&(c=a.as(h[0],T.ImageForma))&&c.bounds.size.similarity(this.gridForma.page.pageSize)<.001&&(this.gridStyle.cropType=p.CropType.FitBorder)}if(this.layoutGrid(this.gridStyle.moveableShift,this.oldBounds,a.clone(t),r),this.gridStyle.cropType=u,null!=this.oldBounds&&(this.setInitialFormaSizes(),e&&null!=t))for(var m=a.iter(t);!m.done;m.next()){var f=m.key,g=m.value;this.formaMapping[f]=g}}},colorGrid:function(e,t){for(var r=a.sort(e,function(e,t){return e.bounds.minY<t.bounds.minY||!(e.bounds.minY>t.bounds.minY)&&e.bounds.minX<t.bounds.minX}),o=[],n=a.iter(r);!n.done;n.next())null!=(b=n.value).colorID&&null!=this.backgroundShapeFormaForCell(b,a.clone(t))&&o.push(b.colorID);var i,s=this.isBackgroundVisible(),u=this.forma.root.style.colors.colorID(h.ColorRole.FieldPrimary);0!=o.length||s||null!=(i=u)&&o.push(i);for(var c=a.iter(this.forma.page.colorLibraryController.getThemeColorKeys());!c.done;c.next()){var d=c.value;o.includes(d)||s&&d==u||o.push(d)}for(var m=this.gridCells.concat(),f=a.sort(m,function(e,t){return e.bounds.center.distanceTo(N.TheoPoint.ZERO)<t.bounds.center.distanceTo(N.TheoPoint.ZERO)}),g=a.iter(this.formaMappingSwiftDict);!g.done;g.next()){var v,C=g.key,b=g.value,F=this.forma.formaByID(C);if(null!=F&&F.isBackgroundImage())(v=a.as(F.controller,p.FrameController))&&(v.isBackgroundImageWithAlpha()||null!=(D=a.indexOf(f,b))&&f.splice(D,1));else if(a.opt(a.opt(F,function(e){return e.controller}),function(e){return e.kind==B.TypeLockupController.KIND})){var y;if((y=a.as(a.opt(F,function(e){return e.controller}),B.TypeLockupController))&&(a.opt(y.lockupStyle,function(e){return e.backing==P.LockupBacking.Banner})||a.opt(y.lockupStyle,function(e){return e.backing==P.LockupBacking.BannerHorizontal})||a.opt(y.lockupStyle,function(e){return e.backing==P.LockupBacking.BannerVertical})||a.opt(y.lockupStyle,function(e){return e.backing==P.LockupBacking.Knockout}))){var D,I,S=a.opt(F,function(e){return e.style.colors.colorID(h.ColorRole.FieldSecondary)});b.colorID=S,null!=(D=a.indexOf(f,b))&&f.splice(D,1),null!=(I=a.indexOf(o,b.colorID))&&o.push(o.splice(I,1))}}}for(var x=[],T=0,M=a.iter(f);!M.done;M.next()){b=M.value;for(var k=!1,_=a.iter(this.formaeForCell(b));!_.done;_.next()){var G,w;(G=t[_.value.formaID])&&null!=(w=G.colorID)&&o.includes(w)&&(k=!0,b.colorID=w,o.length>f.length&&a.remove(o,w))}k||x.push(b)}if(0==o.length)l.CoreAssert.fail("ERROR: incorrectly removed all background colors.");else for(var A=a.iter(x);!A.done;A.next())(b=A.value).colorID=o[T%o.length],T+=1},updateGridColors:function(){for(var e=a.iter(this.gridCells.concat());!e.done;e.next()){var t,r=e.value;(t=this.backgroundShapeFormaForCell(r))&&(r.colorID!=t.style.colors.colorID(h.ColorRole.FieldPrimary)&&(r.colorID=t.style.colors.colorID(h.ColorRole.FieldPrimary)),r.opacity!=t.style.opacity&&(r.opacity=t.style.opacity))}},getCellsSortedByRow:function(){return a.sort(this.gridCells.concat(),function(e,t){return e.bounds.minY<t.bounds.minY||!(e.bounds.minY>t.bounds.minY)&&e.bounds.minX<t.bounds.minX})},getCellsSortedByColumn:function(){return a.sort(this.gridCells.concat(),function(e,t){return e.bounds.minX<t.bounds.minX||!(e.bounds.minX>t.bounds.minX)&&e.bounds.minY<t.bounds.minY})},getContrastingColorForCell:function(e){var t=this.cellForForma(e);if(null!=t){var r=this.forma.page.colorLibraryController,o=[];this.isBackgroundVisible()&&null!=(i=e.root.style.colors.colorID(h.ColorRole.FieldPrimary))&&(l=r.getSolidColorForKey(i))&&o.push(l);for(var n=a.iter(this.gridCells);!n.done;n.next()){var i,l,s=n.value;t!=s&&t.mergeableWith(s)&&null!=(i=s.colorID)&&(l=r.getSolidColorForKey(i))&&o.push(l)}var u=a.clone(this.getContrastingThemeColorsInRandomOrder(a.clone(o)));return r.getTheoColorForKey(u[0])}return null},getContrastingThemeColorsInRandomOrder:function(e){for(var t=a.clone(e),r=this.forma.page.colorLibraryController,o=r.getThemeColorKeys().concat(),n=[];o.length>0;){var i=_.CoreRandom.nextIntUniform(o.length),l=o[i];o.splice(i,1);for(var s=!1,u=a.iter(t);!u.done;u.next()){var c,h=u.value;(c=r.getSolidColorForKey(l))&&c.distanceTo(h)<23&&(s=!0)}s||(n.push(l),t.push(r.getSolidColorForKey(l)))}return n.length<2&&(n=r.getThemeColorKeys().concat()),n},buildCellColorGroups:function(){for(var e=a.clone(this.getCellsSortedByRow()),t={},r=a.iter(e);!r.done;r.next()){var o,n=r.value;if(o=this.backgroundShapeFormaForCell(n)){for(var i=o.formaID,l=!1,s=a.iter(a.keys(t));!s.done;s.next()){var u=s.value;(new G.ProfilingColorMap).checkIfTwoFormaAreInSamePaletteMappingGroup(u,i)&&(t[u].push(n),l=!0)}l||(t[i]=[n])}}return t},shuffleColorAssignment:function(){var e=a.clone(this.buildCellColorGroups()),t=this.forma.page.colorLibraryController,r=[];if(this.isBackgroundVisible()){var o=this.forma.root.style.colors.colorID(h.ColorRole.FieldPrimary);r.push(t.getSolidColorForKey(o))}for(var n=a.clone(this.getContrastingThemeColorsInRandomOrder(a.clone(r))),i=0,l=a.iter(e);!l.done;l.next()){for(var s=l.value,u=a.iter(s);!u.done;u.next()){var c,d=u.value;if(d.colorID=n[i%n.length],c=this.backgroundShapeFormaForCell(d)){var m=(new G.ProfilingColorMap).overridePaletteMappingDueToContrast(d.colorID,c.formaID);c.style.colors.setColorId(h.ColorRole.FieldPrimary,m)}}i+=1}},getCellIdsGroupedByColor:function(){for(var e=a.clone(this.getCellsSortedByRow()),t={},r=a.iter(e);!r.done;r.next()){var o,n,i,l,s=r.value,u=null;if((o=this.backgroundShapeFormaForCell(s))&&(u=o.formaID),(n=this.forma)&&null!=(i=s.colorID)&&(l=n.page.colorLibraryController.getSolidColorForKey(i))){for(var h=l.rgbString,d=!1,m=a.iter(a.keys(t));!m.done;m.next()){var f=m.value;c.ColorSelectorUtils.compareTwoColorStringsWithMargin(f,h)&&null!=u&&(t[f].push(u),d=!0)}d||null==u||(t[h]=[u])}}return t},moveableFormae:function(){for(var e=[],t=a.iter(this.forma.visitAsArray(f.FormaTraversal.JustChildren));!t.done;t.next()){var r=t.value;!r.controller.floating||!r.controller.moveable||r instanceof T.ImageForma||this.isGridCell(r)||e.push(r)}return a.sortInPlace(e,function(e,t){return e.finalFrame.center.distanceTo(N.TheoPoint.ZERO)<t.finalFrame.center.distanceTo(N.TheoPoint.ZERO)}),e},removeOverlapCells:function(e,t){l.CoreAssert.isTrue(["vertical","horizontal"].includes(t));for(var r=[],o=a.iter(a.range(0,e.length,!1));!o.done;o.next()){var n=e[o.value];if(r.length>0){var i=r[r.length-1];"horizontal"==t?a.toDouble(Math.round(1e3*Math.max(n.bounds.minX,i.bounds.minX))/1e3)<a.toDouble(Math.round(1e3*Math.min(n.bounds.maxX,i.bounds.maxX))/1e3)||r.push(n):"vertical"==t&&(a.toDouble(Math.round(1e3*Math.max(n.bounds.minY,i.bounds.minY))/1e3)<a.toDouble(Math.round(1e3*Math.min(n.bounds.maxY,i.bounds.maxY))/1e3)||r.push(n))}else r.push(n)}return r},getCellRegion:function(e,t,r,o){void 0===t&&(t=null),void 0===r&&(r=null),void 0===o&&(o=null);var n=null!=t?t:this.forma.bounds,i=null!=r?r:e.bounds,l=n.evalRect(i).transform(this.forma.totalPlacement).rounded();if(this.foregroundGridCells.includes(e))return l;var s=null!=o?o:this.gridStyle.spacing,u=a.clone(this.getAdjustedSpacingsForCell(e,s)),c=u[0],h=u[1],d=u[2],m=u[3];return new E.TheoRect(l.minX+c,l.minY+d,l.maxX-h,l.maxY-m).rounded()},updateHierarchy:function(){for(var e=a.iter(this.formaMapping);!e.done;e.next()){var t,r=e.value;(t=a.opt(a.opt(this.forma,function(e){return e.root}),function(e){return e.formaByID(r)}))&&(t.parent==this.forma||t.parent.hasIntent(f.Forma.INTENT_INFERRED_TEMP_GROUP)||(t instanceof T.ImageForma?l.CoreAssert.fail("shouldn't have a mapping to an image "):this.gridForma.appendChild(t,!0)))}},layoutGrid:function(e,t,r,o){void 0===t&&(t=null),void 0===r&&(r=null),void 0===o&&(o=null);var n=this;if(!this.blockUpdate&&null!=this.forma.bounds){var i=new C.FormaGeometryChangedEvent(this.forma);this.forma.beginUpdate(i);var l=a.clone(this.moveableFormae()),s=a.clone(F.GroupDetector.detectProximityGroups(a.clone(l))),u=[];if(e&&this.owner.interactionMode!=d.InteractionMode.DefaultInteraction)for(var c=a.iter(this.gridCells.concat());!c.done;c.next()){for(var m=c.value,g=this.getCellRegion(m),b=[],y=a.iter(this.formaeForCell(m));!y.done;y.next()){var D=y.value;a.containsEq(l,D,f._equality_Forma_Forma)&&b.push(D)}b.length>0&&(u=u.concat(b),this.evaluateCellAndSplit(a.clone(b),a.clone(s),g,t,a.clone(r),o))}if(null!=t&&u.length<l.length){for(var I=[],S=a.iter(l);!S.done;S.next())D=S.value,a.containsEq(u,D,f._equality_Forma_Forma)||I.push(D);this.moveFormaeToCell(a.clone(I),this.forma.frame,t,a.clone(r),o)}var x=a.clone(this.forma.filterWithCallback(function(e){return n.isGridCell(e)&&e.isShape()},f.FormaTraversal.JustChildren));this.checkFramesForCropping_=[];for(var T=0,k=a.iter(this.gridCells.concat());!k.done;k.next()){m=k.value,g=this.getCellRegion(m),b=[];for(var _=!1,G=[],N=a.iter(this.formaeForCell(m));!N.done;N.next()){var E=N.value;if(E.isBackgroundImage()){G.push(E);var L,Y,U,X=!1;(L=a.as(E,v.FrameForma))&&(Y=M.ImageFacade.getImageFormaForForma(L))&&(X=Y.hasAlpha()),X||(_=!0),E.frame.area>2*g.area&&this.checkFramesForCropping_.push(E),(U=a.as(E.controller,p.FrameController))&&U.fitWithCrop(g,this.gridStyle.cropType),E.intent=f.Forma.INTENT_GRID_CELL}}if(!_){var H;if(null==(J=this.backgroundShapeFormaForCell(m))?(J=a.as(this.forma.page.createFormaWithController(A.ShapeForma.KIND,w.ShapeController.KIND),A.ShapeForma),R.ShapeLibrary.applyToShapeForma(J,R.ShapeLibrary.Square)):a.remove(x,J),null==m.colorID){var K=a.clone(a.shuffle(this.forma.page.colorLibraryController.getThemeColorKeys()));m.colorID=K[0]}null!=(H=m.colorID)&&(J.contentID=H+a.toString(T)),J.style.opacity=m.opacity,J.style.colors.setColorId(h.ColorRole.FieldPrimary,m.colorID),J.allowUserMove=this.foregroundGridCells.includes(m),J.controller.fit(g),G.splice(0,0,J),this.formaMapping[J.formaID]=m,J.intent=f.Forma.INTENT_GRID_CELL}for(var O=a.iter(G);!O.done;O.next()){var z=O.value,W=this.gridForma.indexOfChild(z);null!=W&&W==T||this.gridForma.insertChildAt(z,T),T+=1}}for(var q=a.iter(x);!q.done;q.next()){var J=q.value;a.removeKey(this.formaMapping,J.formaID),J.removeFromParent()}for(var j=a.iter(u);!j.done;j.next()){var V,Z=j.value;(V=a.as(Z.controller,B.TypeLockupController))&&(this.gridCells.length>1&&this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&(a.opt(V.lockupStyle,function(e){return e.backing==P.LockupBacking.Banner})||a.opt(V.lockupStyle,function(e){return e.backing==P.LockupBacking.BannerHorizontal})||a.opt(V.lockupStyle,function(e){return e.backing==P.LockupBacking.BannerVertical})||a.opt(V.lockupStyle,function(e){return e.backing==P.LockupBacking.Knockout}))&&(a.opt(V.lockupStyle,function(e){return e.textLook=P.LockupTextLook.Fill}),a.opt(V.lockupStyle,function(e){return e.backingArtworkID=null}),a.opt(V.lockupStyle,function(e){return e.backing=P.LockupBacking.None})),V.snapSizeToBounds())}this.forma.endUpdate(i)}},assertCorrectLayout:function(){this.gridStyle},evaluateCellAndSplit:function(e,t,r,o,n,i){if(void 0===o&&(o=null),void 0===n&&(n=null),void 0===i&&(i=null),0!=e.length)if(1!=e.length&&null==o){for(var l=e[0].finalFrame,s=a.iter(e);!s.done;s.next()){var u=s.value;l=l.unionWith(u.finalFrame)}for(var c=Math.max(r.aspectRatio,1/r.aspectRatio),h=Math.max(l.aspectRatio,1/l.aspectRatio),d=r.similarity(l)>.1?Math.min(a.toInt(c-1),Math.max(1,_.MathUtils.absInt(a.toInt(c-h)))):1,m=[],p=a.iter(t);!p.done;p.next()){for(var g=p.value,v=[],C=a.iter(e);!C.done;C.next())u=C.value,a.containsEq(g,u,f._equality_Forma_Forma)&&v.push(u);v.length>0&&m.push(a.clone(v))}for(var b=Math.min(e.length,d),y=a.iter(e);!y.done;y.next()){var D,I;u=y.value,(D=a.as(u.controller,B.TypeLockupController))&&null!=(I=D.averageLineHeight)&&I<.5*B.TypeLockupController.MIN_LINE_HEIGHT&&(b+=1)}m=a.clone(F.GroupDetector.splitFormaGroups(a.clone(m),Math.max(b,1)));var S=null;if(r.aspectRatio>2)S=a.clone(r.insetRel(.1,.1,0,0).split(m.length,!0));else{if(null!=n)return void this.moveFormaeToCell(a.clone(e),r,o,a.clone(n),i);for(var x=this.forma.root.finalFrame.height,T=[],M=a.iter(m);!M.done;M.next())if((g=M.value).length>0){l=g[0].finalFrame;for(var P=a.iter(g);!P.done;P.next())u=P.value,l=l.unionWith(u.finalFrame);T.push(l.height/x+.1)}S=a.clone(r.insetRel(0,0,.1,.1).split(m.length,!1,a.clone(T)))}var k=null;1==m.length&&(k=a.clone(n));for(var G=a.iter(a.range(0,m.length,!1));!G.done;G.next()){var w=G.value;this.moveFormaeToCell(a.clone(m[w]),S[w],null,a.clone(k),i)}}else this.moveFormaeToCell(a.clone(e),r,o,a.clone(n),i)},moveFormaeToCell:function(e,t,r,o,n){if(void 0===r&&(r=null),void 0===o&&(o=null),void 0===n&&(n=null),0!=e.length){var i,l=null;if(i=o)for(var s=null!=r?r:this.forma.bounds,u=a.iter(e);!u.done;u.next()){var c;if(c=i[u.value.formaID]){var h=this.getCellRegion(c,s,void 0,n);null==l||l.equal(h)||x.Host.logging.warning("possible error. more than one old cell. "),l=h}}for(var d=a.sort(e,function(e,t){return e.parent.indexOfChild(e)<t.parent.indexOfChild(t)}),m={},f=a.iter(d);!f.done;f.next()){var p=f.value;a.opt(a.as(p.controller,B.TypeLockupController),function(e){return e.snapSizeToBounds()}),m[p.formaID]=p.parent.indexOfChild(p)}var g=this.forma.page.createFormaWithController(y.GroupForma.KIND,b.GroupController.KIND);g.allowUserMove=!1,g.isModel=!0,this.gridForma.isModel=!0,a.opt(a.as(g.controller,b.GroupController),function(e){return e.usePinResize=null==r}),this.gridForma.appendChild(g);for(var v=d[0].finalFrame,C=a.iter(d);!C.done;C.next())p=C.value,v=v.unionWith(p.finalFrame);null==l?(g.placement=k.Matrix2D.translationXY(v.minX,v.minY),g.bounds=E.TheoRect.fromSize(v.size)):(g.placement=k.Matrix2D.translationXY(l.minX,l.minY),g.bounds=E.TheoRect.fromSize(l.size));var F=t.equal(this.forma.frame)&&null!=r;F&&(g.placement=k.Matrix2D.Identity,g.bounds=E.TheoRect.fromSize(r.size));for(var D=a.iter(d);!D.done;D.next())p=D.value,g.appendChild(p,!0);var I=L.TheoSize.Zero;if(null!=l||F)I=t.size;else{var S=Math.min(50,.05*t.width),T=Math.min(50,.05*t.height),M=t.insetXY(S,T),P=Math.min(M.height,v.height);1==e.length&&(P=Math.max(P,.75*M.height)),I=new L.TheoSize(M.width,P)}g.bounds=E.TheoRect.fromSize(I),g.move(k.Matrix2D.translation(g.finalFrame.evalXY(.5,.5).multiply(-1)).translate(t.center));for(var _=a.iter(d);!_.done;_.next())p=_.value,this.gridForma.insertChildAt(p,m[p.formaID],!0),t.contains(p.finalFrame)||a.opt(x.Host.logging,function(e){return e.warning("warning. child forma "+p.finalFrame.asString+" must be within region "+t.asString+" ")});g.removeFromParent(),this.gridForma.isModel=!1}},getAlignments:function(e){return void 0===e&&(e=!1),[]},postDecode:function(){var e=this;l.CoreAssert.isTrue(null!=this.forma,"forma present"),l.CoreAssert.isTrue(null!=this.gridStyle,"grid style present"),a.opt(this.gridStyle,function(t){return t.forma=e.forma}),this.inferBackgroundCellAssignment(),this.inferGridCellAssignment(),this.updateGridColors()},canMoveShape:function(e){if(e.parent!=this.forma)return!1;var t;if(l=this.cellForForma(e))return this.foregroundGridCells.includes(l);if(t=e.finalFrame){for(var r={},o=[],n=a.iter(this.gridCells.concat());!n.done;n.next()){var i,l=n.value,s=this.getCellRegion(l);(i=t.intersectionWith(s))&&i.area/s.area>.6&&(r[l]=i.area/s.area,o.push(l))}if(o.length>0)return a.sortInPlace(o,function(e,t){return r[e]>r[t]}),this.foregroundGridCells.includes(o[0])}return!1}}}),n)},26:function(e,t,r){var o,n=t,i=r(0),a=r(39),l=r(1),s=r(70),u=r(27),c=r(156),h=r(123),d=r(11),m=r(117),f=r(82),p=r(29),g=r(161),v=r(139),C=r(44),b=r(25),F=r(43),y=r(23),D=r(116),I=r(8),S=r(159),x=r(89),T=r(21),M=r(91),P=r(506),k=r(9),_=r(37),G=r(35),w=r(54),A=r(30),R=r(40),B=r(124),N=r(15),E=r(10),L=r(28),Y=r(73);n.FitType=i.defineEnum("FitType",{None:0,ProportionalFit:1,ProportionalFill:2,Stretch:3}),n.CropType=i.defineEnum("CropType",{PreserveSize:0,FitBorder:1,FillFocus:2,ExtremeCloseup:3,AbstractCloseup:4,PreserveFocus:5}),n.FrameController=(o=function(e,t,r){F.GroupController.call(this,e,t,r)},i.defineClass({name:"FrameController",ctor:o,superName:"GroupController",statics:{KIND:{get:function(){return"frame"}}},props:{moveable:{get:function(){if(null!=this.forma.allowUserMove)return this.forma.allowUserMove;for(var e=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!e.done;e.next())if(e.value.controller.moveable)return!1;return!0}},selectable:{get:function(){return!0}},replaceable:{get:function(){return!this.moveable||this.forma.isLogo()||this.forma.isSticker()}},duplicatable:{get:function(){for(var e=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!e.done;e.next())if(!e.value.controller.duplicatable)return!1;return!0}},rotateable:{get:function(){for(var e=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!e.done;e.next())if(!e.value.controller.rotateable)return!1;return!0}},flippable:{get:function(){for(var e=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!e.done;e.next())if(!e.value.controller.flippable)return!1;return!0}},nudgeable:{get:function(){for(var e=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!e.done;e.next())if(!e.value.controller.nudgeable)return!1;return!0}},copyTo:function(e){var t,r,o;if(void 0===e&&(e=null),l.CoreAssert.isTrue(null==e||e==i.opt(i.opt(this.owner,function(e){return e.document}),function(e){return e.firstPage}),"FrameController does not currently support copying across pages"),(t=i.opt(i.opt(this.owner,function(e){return e.document}),function(e){return e.firstPage}))&&(r=i.as(this.forma,p.FrameForma))&&(o=M.ImageFacade.getImageFormaForForma(r))){var n,c=o.contentNode,h=null;return(n=i.as(o,Y.VideoForma))&&(c=n.videoContentNode,h=n.contentNode),null==c?u.CorePromise.resolve(null):s.CreationFacade.addContent(t,c,h).then(function(e){var t,n,l;return(t=i.as(e,d.Forma))?(t.match(r),(n=i.as(t,p.FrameForma))&&(l=M.ImageFacade.getImageFormaForForma(n))&&l.match(o),i.opt(I.Host.logging,function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsDataImageDuplicated,{})}),t):u.CorePromise.reject("got no forma from addContent")})}return u.CorePromise.resolve(null)},flip:function(e){var t,r;void 0===e&&(e=!1),this.floating?B.TransformFacade.flipForma(this.forma,e):(t=i.as(this.forma,p.FrameForma))&&(r=t.childAt(0))&&(B.TransformFacade.flipForma(r,e),this.updateParentGroup())},rotate:function(e){var t,r;void 0===e&&(e=Math.PI/180),this.floating?B.TransformFacade.rotateForma(this.forma,e):(t=i.as(this.forma,p.FrameForma))&&(r=t.childAt(0))&&(B.TransformFacade.rotateForma(r,e),this.updateParentGroup())},rotation:function(){return this.floating?this.forma.rotation():(e=i.as(this.forma,p.FrameForma))&&(t=e.childAt(0))?t.rotation():0;var e,t},nudge:function(e){var t,r;this.floating?B.TransformFacade.translateForma(this.forma,e):(t=i.as(this.forma,p.FrameForma))&&(r=t.childAt(0))&&(B.TransformFacade.translateForma(r,e),this.updateParentGroup())},selectionHandlePositions:{get:function(){return this.maintainAspectRatio?F.GroupController._getters.selectionHandlePositions.call(this):[new N.TheoPoint(.5,0),new N.TheoPoint(.5,1),new N.TheoPoint(1,.5),new N.TheoPoint(0,.5)]}},processEvent:function(e){var t;return(t=i.as(e,f.BeginPointerTrackingEvent))?(t.trackingResponse=this.moveable?m.BeginPointerTrackingResponseEnum.TrackAsGroup:m.BeginPointerTrackingResponseEnum.TrackWithinGroup,!1):F.GroupController.prototype.processEvent.call(this,e)},processFormaDoubleClick:function(e){if(e.forma.isSticker()&&(this.owner.selection.replaceSelection(e.forma),this.owner.selection.isSelected(e.forma)))for(var t=i.iter(e.forma.visitAsArray(d.FormaTraversal.JustChildren));!t.done;t.next()){var r,o=t.value;(r=i.as(o.controller,x.ImageController))&&(this.owner.controllerSettingsState.settings=new c.ImageControllerSettings(r))}},processEndFormaDrag:function(e){var t,r=this.owner.document.firstPage;r.publish(new v.EndFormaDragMessage(r)),this.fitChildrenToFrame(),(t=i.as(i.opt(this.forma.parent,function(e){return e.controller}),b.GridController))&&t.processChildEndFormaDrag(e)},processBeginFormaDrag:function(e){var t;F.GroupController.prototype.processBeginFormaDrag.call(this,e),(t=i.as(i.opt(this.forma.parent,function(e){return e.controller}),b.GridController))&&t.processChildBeginFormaDrag(this.forma,e)},afterProcessBeginFormaDrag:function(e){var t;(t=i.as(i.opt(this.forma.parent,function(e){return e.controller}),b.GridController))&&t.processChildBeginFormaDrag(this.forma,e)},processFormaResize:function(e){var t;(t=this.forma.bounds)&&(F.GroupController.prototype.processFormaResize.call(this,e),this.setChildrenCropping(this.maintainAspectRatio?n.CropType.FitBorder:n.CropType.PreserveFocus,t))},processBeginFormaResize:function(e){F.GroupController.prototype.processBeginFormaResize.call(this,e)},processEndFormaResize:function(e){F.GroupController.prototype.processEndFormaResize.call(this,e),this.updateParentGroup()},processFormaDrag:function(e){var t;F.GroupController.prototype.processFormaDrag.call(this,e),(t=i.as(i.opt(this.forma.parent,function(e){return e.controller}),b.GridController))&&t.processChildFormaDrag(this.forma,e)},afterProcessFormaDrag:function(e){var t;(t=i.as(i.opt(this.forma.parent,function(e){return e.controller}),b.GridController))&&t.processChildFormaDrag(this.forma,e)},match:function(e){F.GroupController.prototype.match.call(this,e),this.forma.bounds.equal(e.forma.bounds)||this.setChildrenCropping(this.maintainAspectRatio?n.CropType.FitBorder:n.CropType.PreserveSize,null)},fit:function(e){this.fitWithCrop(e,this.maintainAspectRatio?n.CropType.FitBorder:n.CropType.PreserveFocus)},fitWithCrop:function(e,t){var r=this.forma.bounds;this.forma.bounds=E.TheoRect.fromSize(this.maintainAspectRatio?e.fitAspectRatioWithin(r.aspectRatio):e.size),this.forma.moveCenterToPoint(e.center),this.setChildrenCropping(t,r)},setChildrenCropping:function(e,t){var r=this;this.forma.visitAll(d.FormaTraversal.JustChildren,function(o){var n;(n=i.as(o.controller,x.ImageController))&&(r.isBackgroundImageWithAlpha()||n.setCrop(r.forma.bounds,t,e))}),this.fitChildrenToFrame()},isBackgroundImageWithAlpha:function(){var e=!1;return this.forma.isBackgroundImage()&&this.forma.visitAll(d.FormaTraversal.JustChildren,function(t){var r=i.as(t,T.ImageForma);null!=r&&r.hasAlpha()&&(e=!0)}),e},fitChildrenToFrame:function(e){void 0===e&&(e=!1);var t=this;this.forma.visitAll(d.FormaTraversal.JustChildren,function(r){var o=i.as(r,T.ImageForma);if(null!=o&&null!=r.bounds&&null!=t.forma.bounds)if(i.opt(i.opt(o,function(e){return e.animation}),function(e){return e.invalidate()}),e||!o.hasAlpha()||o.hasIntent(d.Forma.INTENT_PATTERN))t.ensureImageFillsFrame(o,e);else{var n,a=1;(n=i.opt(o.page.view,function(e){return e.getViewportTransform()}))&&(a=Math.sqrt(Math.abs(n.determinant))),h.DragFacade.rescueToArbitraryBounds(o,t.forma.bounds,t.forma.totalPlacement,36/a,30/a)}})},ensureImageFillsFrame:function(e,t){void 0===t&&(t=!1);var r=this.forma.bounds.transform(e.placement.inverse),o=r.height/e.bounds.height,n=r.width/e.bounds.width,i=_.MathUtils.maxDouble(n,o);(i>1||t)&&(e.move(k.Matrix2D.uniformScaling(i)),r=this.forma.bounds.transform(e.placement.inverse)),r.minX<=e.bounds.minX&&(e.placement=e.placement.precat(k.Matrix2D.translationXY(r.minX-e.bounds.minX,0)),r=this.forma.bounds.transform(e.placement.inverse)),r.maxX>=e.bounds.maxX&&(e.placement=e.placement.precat(k.Matrix2D.translationXY(r.maxX-e.bounds.maxX,0)),r=this.forma.bounds.transform(e.placement.inverse)),r.minY<=e.bounds.minY&&(e.placement=e.placement.precat(k.Matrix2D.translationXY(0,r.minY-e.bounds.minY)),r=this.forma.bounds.transform(e.placement.inverse)),r.maxY>=e.bounds.maxY&&(e.placement=e.placement.precat(k.Matrix2D.translationXY(0,r.maxY-e.bounds.maxY)),r=this.forma.bounds.transform(e.placement.inverse))},isImageCropped:function(){var e=this.forma.finalFrame,t=!1;return this.forma.visitAll(d.FormaTraversal.JustChildren,function(r){var o=i.as(r,T.ImageForma);l.CoreAssert.isTrue(null!=o,"frame child is not an image"),r.finalFrame.equal(e)||(t=!0)}),t},getAverageEdgeGrid:function(e,t){void 0===t&&(t=!0);var r,o=[];if(r=this.forma.frame)for(var n=new L.TheoSize(r.width/e.width,r.height/e.height),a=i.iter(i.range(0,i.toInt(e.width),!1));!a.done;a.next())for(var l=a.value,s=i.iter(i.range(0,i.toInt(e.height),!1));!s.done;s.next()){var u=s.value,c=E.TheoRect.fromXYWH(i.toDouble(l)*n.width+r.origin.x,i.toDouble(u)*n.height+r.origin.y,n.width,n.height),h=this.getAverageEdge(c);o.push(h)}if(t){for(var d=[],m=1e-5,f=i.iter(o);!f.done;f.next())m+=h=f.value;for(var p=i.iter(o);!p.done;p.next())h=p.value,d.push(h/m);return d}return o},getAverageEdge:function(e){var t=e.transform(this.forma.placement.inverse),r=0;return this.forma.visitAll(d.FormaTraversal.JustChildren,function(e){e instanceof T.ImageForma&&(r+=e.getAverageEdge(t))}),r},getFaceIntersections:function(e){var t=e.transform(this.forma.placement.inverse),r=0;return this.forma.visitAll(d.FormaTraversal.JustChildren,function(e){e instanceof T.ImageForma&&(r+=e.getFaceIntersections(t))}),r},getAverageColor:function(e){var t=e.transform(this.forma.placement.inverse),r=null;return this.forma.visitAll(d.FormaTraversal.JustChildren,function(e){e instanceof T.ImageForma&&(r=e.getAverageColor(t))}),r},updateGroup:function(){this.floating&&this.fitChildrenToFrame(!0)},maintainAspectRatio:{get:function(){return this.moveable}},placeAsLogo:function(){var e,t,r,o;if((e=i.as(this.forma,p.FrameForma))&&(t=e.root)&&(r=M.ImageFacade.getImageFormaForForma(e))&&(o=r.bounds)&&r.isLogo()){var n,a=.12*Math.max(t.finalFrame.height,t.finalFrame.width);if(o.aspectRatio>1?this.fit(new E.TheoRect(0,0,a,a/o.aspectRatio)):this.fit(new E.TheoRect(0,0,a*o.aspectRatio,a)),n=new P.LogoPlacementSuggester(this.forma,i.opt(this.forma,function(e){return e.root})).fastPlacement()){var l=new C.FormaTransformChangedEvent(this.forma);l.duration=0,i.opt(this.forma,function(e){return e.beginUpdate(l)}),n.apply(),i.opt(this.forma,function(e){return e.endUpdate(l)})}this.bringToForeground()}},bringToForeground:function(){var e,t;(e=i.as(this.forma,p.FrameForma))&&(t=e.parent)&&(t.removeChild(e),t.appendChild(e))},addForma:function(e,t,r){var s,c;if((s=i.as(e.root,G.RootForma))&&(c=i.as(t,p.FrameForma))){var h=!1,m=M.ImageFacade.getImageFormaForForma(c);if(i.opt(m,function(e){return null==e.frame}))return s.appendChild(t),u.CorePromise.resolve(null);var f=i.clone(s.filterWithCallback(function(e){return e.isBackgroundImage()})),v=i.clone(s.filterByControllerKind(b.GridController.KIND)),F=r.forceAlphaImageAsBackground;if(null!=m&&m.hasAlpha()&&(c.allowUserMove=!F),null==m||null!=m&&m.controller.moveable||1==F){var x;if(x=m)for(var T=i.iter(s.filterWithCallback(function(e){return e.isBackgroundImage()}));!T.done;T.next()){var P,k=T.value;if(P=M.ImageFacade.getImageStyleForForma(k)){var _=P.clone();_.adjustments=S.ImageAdjustments.createDefault(),M.ImageFacade.applyImageStyle(_,[x])}}v.length>0?i.opt(i.as(v[0].controller,b.GridController),function(e){return e.addFormaToGroup(c)}):s.insertChildAt(c,0),h=!0}if(l.CoreAssert.isTrue(v.length<=1,"can't have more than one grid at the moment"),f.length>0&&!c.controller.moveable||v.length>0){var w=null;if(0==v.length){var A=e.createFormaWithController(y.GroupForma.KIND,b.GridController.KIND);w=i.as(A.controller,b.GridController),s.insertChildAt(A,0),A.applyStyle(D.GridStyle.createDefault()),A.bounds=s.bounds}else w=i.as(v[0].controller,b.GridController);for(var R=i.clone(s.filterByKind(p.FrameForma.KIND,d.FormaTraversal.JustChildren)),B=i.iter(R);!B.done;B.next()){var N=k=B.value;null!=N.finalFrame?0==N.childCount?(l.CoreAssert.fail("empty frame?"),N.removeFromParent()):w.addFormaToGroup(N):l.CoreAssert.fail("nil frame")}for(var L=i.iter(R);!L.done;L.next()){var Y;(Y=(k=L.value).frame)&&k.controller.fitWithCrop(Y,n.CropType.FitBorder)}for(var U=i.iter(s.filterWithCallback(function(e){return e.controller.moveable&&!e.isLogo()},d.FormaTraversal.JustChildren));!U.done;U.next())t=U.value,w.forma.appendChild(t,!0);null==m||m.controller.moveable||F||w.forma.appendChild(c)}else l.CoreAssert.fail("Shouldn't be hitting this code path now that grid are created by default. Let here for the moment since we're near release."),null==m||m.controller.moveable||F?i.opt(i.opt(i.opt(m,function(e){return e.contentNode}),function(e){return e.image}),function(e){return e.whenLoaded(function(){var e=new C.FormaTransformChangedEvent(c);if(e.duration=.3,c.beginUpdate(e),0==i.clone(s.filterByControllerKind(b.GridController.KIND)).length){var t=E.TheoRect.fromSize(s.page.pageSize);c.controller.fitWithCrop(t,n.CropType.FitBorder)}c.endUpdate(e)})}):s.appendChild(c);return null!=m&&i.opt(I.Host.logging,function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsImageAddedToFrame,{hasAlpha:m.hasAlpha()?"true":"false",isLogo:m.isLogo()?"true":"false",isBackground:h?"true":"false"})}),null==m||m.controller.moveable||F?1==i.clone(s.filterWithCallback(function(e){return e.isBackgroundImage()})).length&&i.opt(i.opt(i.opt(m,function(e){return e.contentNode}),function(e){return e.image}),function(e){return e.whenLoaded(function(){return s.page.colorLibraryController.extractImageColors()})}):m.isLogo()?i.as(c.controller,o).placeAsLogo():i.opt(i.opt(i.opt(m,function(e){return e.contentNode}),function(e){return e.image}),function(e){return e.whenLoaded(function(){var e;r.suggestPlacement?(e=new g.FormaPlacementSuggester(t,s).fastPlacement())&&e.apply():i.opt(t.controller,function(e){return e.fit(s.frame.insetRel(.25,.25,.25,.25))})})}),u.CorePromise.resolve(null)}return u.CorePromise.reject("couldn't get critical references")},getCurrentColors:function(e){for(var t=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!t.done;t.next()){var r=t.value;if(r.kind==T.ImageForma.KIND)return r.controller.getCurrentColors(e)}return[]},replaceWithColoredShape:function(){var e;if(e=i.as(this.forma.page.createFormaWithController(A.ShapeForma.KIND,w.ShapeController.KIND),A.ShapeForma)){R.ShapeLibrary.applyToShapeForma(e,R.ShapeLibrary.Square),e.contentID=null,e.preScale=null,e.allowUserMove=!1;var t=this.forma.parent;if(t.controller.replaceChildWithForma(this.forma,e),null!=t.indexOfChild(e)&&i.opt(this.forma,function(e){return null==e.parent}))return e}return null},cropSizeCheck:function(){var e=this,t=this.forma.finalFrame;this.forma.visitAll(d.FormaTraversal.JustChildren,function(r){var o,a;(o=i.as(r.controller,x.ImageController))&&(a=r.finalFrame)&&t.area<.4*a.area&&o.setCrop(e.forma.bounds,null,n.CropType.FitBorder)}),this.fitChildrenToFrame()}}}),o)},43:function(e,t,r){var o,n=t,i=r(0),a=r(39),l=r(1),s=r(19),u=r(11),c=r(197),h=r(122),d=r(23),m=r(8),f=r(159),p=r(89),g=r(21),v=r(9),C=r(468),b=r(469),F=r(14),y=r(248);n.GroupController=(o=function(e,t,r){this.blockedUpdate_=0,this.resizeLayoutController_=null,this.usePinResize_=!1,c.FormaController.call(this,e,t,r)},i.defineClass({name:"GroupController",ctor:o,superName:"FormaController",statics:{KIND:{get:function(){return"group"}}},props:{oldBounds:{get:function(){return this.oldBounds_}},updatedChild:{get:function(){return this.updatedChild_},set:function(e){this.updatedChild_=e}},usePinResize:{get:function(){return this.usePinResize_},set:function(e){this.usePinResize_=e}},maintainAspectRatio:{get:function(){if(this.forma.hasIntent(u.Forma.INTENT_INFERRED_TEMP_GROUP))for(var e=i.iter(this.forma.visitAsArray(u.FormaTraversal.JustChildren));!e.done;e.next()){var t=e.value;if(null!=t.controller&&t.finalFrame.equalWithAccuracy(this.forma.finalFrame,10))return t.controller instanceof F.TypeLockupController||t.controller.maintainAspectRatio}return!1}},clone:function(e){return c.FormaController.prototype.clone.call(this,e)},beginBlockedUpdate:function(){this.blockedUpdate_+=1},endBlockedUpdate:function(){this.blockedUpdate_-=1},blockUpdate:{get:function(){return this.blockedUpdate_>0}},addFormaToGroup:function(e){var t;(t=i.as(this.forma,d.GroupForma))&&t.appendChild(e,!0)},removeFormaFromGroup:function(e){var t;(t=i.as(this.forma,d.GroupForma))&&(i.opt(i.as(e.controller,o),function(e){return e.handleRemoval()}),t.removeChild(e))},handleRemoval:function(){},replaceChildWithForma:function(e,t,r){var o,n,u,c;if(void 0===r&&(r=!1),e.kind==g.ImageForma.KIND&&l.CoreAssert.isTrue(t.kind==g.ImageForma.KIND,"replacing an ImageForma with a "+t.kind),(n=i.as(this.forma,d.GroupForma))&&(u=e.frame)&&null!=(c=n.indexOfChild(e))){n.insertChildAt(t,c),null!=e.allowUserMove&&(t.allowUserMove=e.allowUserMove),e.removeFromParent();var h=e.style.colors.colorID(s.ColorRole.FieldPrimary),C=e.style.colors.colorID(s.ColorRole.FieldSecondary);null!=h&&t.style.colors.setColorId(s.ColorRole.FieldPrimary,h),null!=C&&t.style.colors.setColorId(s.ColorRole.FieldSecondary,C),t.controller.fit(u);var b,F=i.clone(t.filterByKind(g.ImageForma.KIND)),y=i.clone(e.filterByKind(g.ImageForma.KIND));if(F.length>0){for(var D=i.iter(F);!D.done;D.next()){var I,S=D.value;if(I=i.as(S.controller,p.ImageController)){var x=S;x.hasAlpha()&&e.isBackgroundImage()&&(t.allowUserMove=!1),i.opt(m.Host.logging,function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsImageReplaced,{hasAlpha:x.hasAlpha()?"true":"false",isLogo:x.isLogo()?"true":"false",isBackground:I.floating?"false":"true"})})}if(y.length>0){var T,M,P=r,k=y[0],_=k.style.clone(),G=i.opt(i.opt(_,function(e){return e.adjustments}),function(e){return e.blur});if(i.opt(_,function(e){return e.adjustments=f.ImageAdjustments.createDefault()}),i.opt(i.opt(_,function(e){return e.adjustments}),function(e){return e.blur=(o=G)||null!=o?o:0}),S.applyStyle(_),0==P&&(T=i.opt(S.contentNode,function(e){return e.mediaMetadata}))&&(M=i.opt(k.contentNode,function(e){return e.mediaMetadata}))&&null!=T.assetID&&null!=M.assetID&&T.assetID==M.assetID&&(P=!0),1==P){var w=e.isBackgroundImage(),A=1==w?S:t,R=1==w?k:e,B=v.Matrix2D.uniformScaling(A.bounds.aspectRatio>=1?A.bounds.width/R.bounds.width:A.bounds.height/R.bounds.height);A.placement=B.inverse.concat(R.placement)}}}i.opt(i.opt(i.opt(i.as(F[0],g.ImageForma),function(e){return e.contentNode}),function(e){return e.image}),function(e){return e.whenLoaded(function(){return F[0].page.colorLibraryController.extractImageColors()})})}t.controller.fit(u),(b=i.opt(i.opt(i.opt(this.forma,function(e){return e.page.document}),function(e){return e.controller}),function(e){return e.selection}))&&(b.isSelected(e)&&b.deselectForma(e),l.CoreAssert.isTrue(b.selectedCount==b.asFormaArray().length))}},match:function(e){c.FormaController.prototype.match.call(this,e),this.updateGroup()},postClone:function(e){},getPinBounds:function(e){return e==y.PinBoundsType.ChildrenBounds?this.forma.childrenBoundsInCoordSpace(v.Matrix2D.Identity):i.opt(this.forma,function(e){return e.bounds})},childUpdate:function(e){void 0===e&&(e=null),this.updatedChild_=e,this.updateGroup()},beginChildResizeEvent:function(e){},endChildResizeEvent:function(e){},childMoveableInDirection:function(e,t){return!0},groupVisualParent:{get:function(){return h.GroupDetector.getGroupVisualParent(this.forma)}},processFormaDrag:function(e){c.FormaController.prototype.processFormaDrag.call(this,e)},processBeginFormaDrag:function(e){c.FormaController.prototype.processBeginFormaDrag.call(this,e)},processEndFormaDrag:function(e){c.FormaController.prototype.processEndFormaDrag.call(this,e)},canClaimForma:function(e){return!1},claimForma:function(e){this.forma!=e.parent&&!i.eq(u._equality_Forma_Forma,this.forma,e)&&this.canClaimForma(e)&&i.opt(i.as(this.forma,d.GroupForma),function(t){return t.appendChild(e,!0)})},beginUpdateGroup:function(e){void 0===e&&(e=null),null==this.oldBounds_&&(this.oldBounds_=null!=e?e:i.opt(this.forma,function(e){return e.bounds}),this.resizeLayoutController_=this.kind!=o.KIND||this.usePinResize?new C.PinLayoutController(this.forma):new b.SpringLayoutController(this.forma),i.opt(this.resizeLayoutController_,function(e){return e.beginUpdateGroup()}))},endUpdateGroup:function(){this.oldBounds_=null,i.opt(this.resizeLayoutController_,function(e){return e.endUpdateGroup()}),this.resizeLayoutController_=null},updateGroup:function(){this.blockUpdate||null==this.oldBounds_||this.oldBounds_.equal(this.forma.bounds)||(this.beginBlockedUpdate(),i.opt(this.resizeLayoutController_,function(e){return e.updateGroup()}),this.endBlockedUpdate())}}}),o)},54:function(e,t,r){var o,n=t,i=r(0),a=r(39),l=r(70),s=r(27),u=r(156),c=r(320),h=r(19),d=r(11),m=r(197),f=r(117),p=r(82),g=r(161),v=r(44),C=r(25),b=r(8),F=r(9),y=r(92),D=r(35),I=r(30),S=r(40),x=r(121),T=r(15);n.ShapeController=(o=function(e,t,r){m.FormaController.call(this,e,t,r)},i.defineClass({name:"ShapeController",ctor:o,superName:"FormaController",statics:{KIND:{get:function(){return"shape"}}},props:{duplicatable:{get:function(){return this.forma.hasIntent(d.Forma.INTENT_ICON)}},selectable:{get:function(){return null==this.forma||null==x.TheoDocumentUtils.getCellBackgroundImage(this.forma)}},rotateable:{get:function(){return this.forma.hasIntent(d.Forma.INTENT_ICON)||this.forma.hasIntent(d.Forma.INTENT_FLOATING_SHAPE)}},moveable:{get:function(){return null!=this.forma.allowUserMove?this.forma.allowUserMove:!(!this.forma.hasIntent(d.Forma.INTENT_ICON)&&!this.forma.hasIntent(d.Forma.INTENT_FLOATING_SHAPE))||((e=i.as(i.opt(i.opt(this.forma,function(e){return e.parent}),function(e){return e.controller}),C.GridController))?e.canMoveShape(this.forma):m.FormaController._getters.moveable.call(this));var e}},floating:{get:function(){return!(!this.forma.hasIntent(d.Forma.INTENT_ICON)&&!this.forma.hasIntent(d.Forma.INTENT_FLOATING_SHAPE))||!this.forma.hasIntent(d.Forma.INTENT_GRID_CELL)&&m.FormaController._getters.floating.call(this)}},deleteable:{get:function(){var e,t;return(e=i.opt(this.forma,function(e){return e.finalFrame}))&&(t=i.opt(i.opt(this.forma,function(e){return e.root}),function(e){return e.finalFrame}))?!e.equal(t):m.FormaController._getters.deleteable.call(this)}},replaceable:{get:function(){return!(!i.opt(this.forma,function(e){return null!=e.controller})||this.forma.isGridCell()&&this.forma.controller.moveable)}},flippable:{get:function(){return this.forma.hasIntent(d.Forma.INTENT_ICON)}},nudgeable:{get:function(){return this.forma.hasIntent(d.Forma.INTENT_ICON)}},maintainAspectRatio:{get:function(){return this.forma.hasIntent(d.Forma.INTENT_ICON)}},selectionHandlePositions:{get:function(){return this.forma.hasIntent(d.Forma.INTENT_GRID_CELL)?[new T.TheoPoint(.5,0),new T.TheoPoint(.5,1),new T.TheoPoint(1,.5),new T.TheoPoint(0,.5)]:m.FormaController._getters.selectionHandlePositions.call(this)}},processFormaResize:function(e){m.FormaController.prototype.processFormaResize.call(this,e)},processBeginFormaResize:function(e){m.FormaController.prototype.processBeginFormaResize.call(this,e)},processEndFormaResize:function(e){m.FormaController.prototype.processEndFormaResize.call(this,e),this.updateParentGroup()},processEvent:function(e){var t;return(t=i.as(e,p.BeginPointerTrackingEvent))?(t.trackingResponse=f.BeginPointerTrackingResponseEnum.TrackAsGroup,!1):m.FormaController.prototype.processEvent.call(this,e)},processFormaDoubleClick:function(e){this.owner.selection.replaceSelection(e.forma),this.owner.controllerSettingsState.settings=new u.ShapeControllerSettings(this)},addForma:function(e,t,r){var o;if(o=i.as(e.root,D.RootForma)){for(var n,a,l,u=i.clone(o.filterWithCallback(function(e){return e.isTypeLockup()})),c=null,d=i.iter(u);!d.done;d.next()){var m;(m=d.value.style.colors.fieldPrimary)&&(c=m)}return(n=i.as(t,I.ShapeForma))&&(a=i.opt(i.as(o.controller,y.RootController),function(e){return e.getGridController()}))&&(a.forma.appendChild(n),r.suggestPlacement&&(l=new g.FormaPlacementSuggester(n,o).fastPlacement())&&l.apply()),null==c?i.opt(this.forma,function(e){return e.style.colors.setColorId(h.ColorRole.FieldPrimary,o.page.colorLibraryController.getThemeColorKeys()[0])}):i.opt(this.forma,function(e){return e.style.colors.setColor(h.ColorRole.FieldPrimary,c)}),this.contrastCheck(!1),s.CorePromise.resolve(null)}return s.CorePromise.reject("failed to get critical references")},getSuggestableColors:function(){for(var e=this.forma.page.colorLibraryController,t=i.clone(e.getColorThemeAsArrayOfTheoColors()),r=[],o=this.getBackgroundColor(),n=i.iter(t);!n.done;n.next()){var a=n.value;if(!a.isBrandkitColor()){if(this.floating&&null!=o&&!o.contrasts(a.rgbColor,!1))continue;r.push([a])}}return r},fit:function(e){var t;(t=i.as(this.forma,I.ShapeForma))&&(t.size=this.maintainAspectRatio?e.fitAspectRatioWithin(t.bounds.aspectRatio):e.size,t.placement=F.Matrix2D.Identity,t.moveCenterToPoint(e.center))},setNewShape:function(e){var t=new v.FormaGeometryChangedEvent(this.forma);this.forma.beginUpdate(t),S.ShapeLibrary.applyToShapeForma(this.forma,e),this.forma.endUpdate(t)},copyTo:function(e){var t;if(void 0===e&&(e=null),t=i.as(this.forma,I.ShapeForma)){var r=e||t.page,n=r.createFormaWithController(I.ShapeForma.KIND,o.KIND);return n.match(t),l.CreationFacade.addForma(r,n,new l.AddFormaParams(void 0,!1)).then(function(e){return n.style.match(t.style),n.intent=t.intent,n.contentID=t.contentID,t.hasIntent(d.Forma.INTENT_ICON)?i.opt(b.Host.logging,function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsDataIconDuplicated,{})}):i.opt(b.Host.logging,function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsDataShapeDuplicated,{})}),n})}return s.CorePromise.reject("Why calling ShapeController.duplicate but not for a shape forma?")},shuffleColorAssignment:function(){var e,t;if((e=i.as(this.forma,I.ShapeForma))&&(t=i.as(i.opt(i.opt(this.forma,function(e){return e.parent}),function(e){return e.controller}),C.GridController)))if(C.GridController.isBackgroundColoredCell(this.forma)){var r;(r=t.getContrastingColorForCell(this.forma))&&this.applyColors([r])}else{var o=new c.ProfilingPrimaryColorSelector(e,!1).selectColorForGlobalRecolor();e.style.colors.setColorId(h.ColorRole.FieldPrimary,o)}}}}),o)},652:function(e,t,r){var o,n=t,i=r(0),a=r(43);n.PROPERTY_SIZE_DEPRECATED="size",n.ResponsiveController=(o=function(e,t,r){a.GroupController.call(this,e,t,r)},i.defineClass({name:"ResponsiveController",ctor:o,superName:"GroupController",statics:{KIND:{get:function(){return"responsive"}}}}),o)},89:function(e,t,r){var o,n=t,i=r(0),a=r(1),l=r(156),s=r(19),u=r(197),c=r(26),h=r(117),d=r(82),m=r(29),f=r(21),p=r(80),g=r(252),v=r(9),C=r(119),b=r(124),F=r(10);n.ImageController=(o=function(e,t,r){u.FormaController.call(this,e,t,r)},i.defineClass({name:"ImageController",ctor:o,superName:"FormaController",statics:{KIND:{get:function(){return"image"}},replaceImageWithLivePhoto:function(e,t){var r,o=t.parent;i.opt(e.parent,function(e){return e.appendChild(t)}),t.contentID=e.contentID,t.match(e),e.removeFromParent(),(r=o)&&r.removeFromParent()}},props:{selectable:{get:function(){return!i.opt(i.opt(this.forma,function(e){return e.parent}),function(e){return e.kind==m.FrameForma.KIND})}},rotateable:{get:function(){return!0}},duplicatable:{get:function(){return this.floating}},replaceable:{get:function(){return!this.floating||this.forma.isLogo()}},flippable:{get:function(){return!this.forma.isLogo()}},nudgeable:{get:function(){return!0}},floating:{get:function(){var e;return(e=i.as(i.opt(this.forma,function(e){return e.parent}),m.FrameForma))&&null!=e.allowUserMove?!!e.allowUserMove:null!=this.forma&&(this.forma.isLogo()||this.forma.hasAlpha())}},moveable:{get:function(){var e;return(e=i.as(this.forma,f.ImageForma))?null!=e.allowUserMove?e.allowUserMove:!i.opt(e.parent,function(e){return e.kind==m.FrameForma.KIND})||!this.floating:u.FormaController._getters.moveable.call(this)}},match:function(e){},setCrop:function(e,t,r){var o,n=this;if(o=i.opt(this.forma,function(e){return e.bounds}))if(r==c.CropType.PreserveFocus&&null!=t){var l=this.forma.placement.transformValuesRKST,s=v._asterisk_Matrix2D_Matrix2D(v._asterisk_Matrix2D_Matrix2D(new v.Matrix2D(l.rotCosine,l.rotSine,-l.rotSine,l.rotCosine,0,0),new v.Matrix2D(1,0,l.skew,1,0,0)),new v.Matrix2D(l.xscale>0?1:-1,0,0,l.yscale>0?1:-1,0,0)),u=v._asterisk_Matrix2D_Matrix2D(new v.Matrix2D(Math.abs(l.xscale),0,0,Math.abs(l.yscale),0,0),new v.Matrix2D(1,0,0,1,l.tx,l.ty)),h=v._asterisk_TheoRect_Matrix2D(o,this.forma.placement).intersectionWith(t);null==h&&(h=t);var d,m,p=v._asterisk_TheoRect_Matrix2D(h,u.inverse),C=h.center,b=t.locate(C.x,C.y);(d=i.opt(i.as(this.forma,f.ImageForma),function(e){return e.getFocusRegion()}))&&(m=d.intersectionWith(h))&&(b=t.locate(m.center.x,m.center.y));var y=v.Matrix2D.calculateResizeTransform(p,e,b,c.FitType.ProportionalFit),D=v._asterisk_Matrix2D_Matrix2D(s,y),I=e.transform(D.inverse);o.contains(I)||(y=v.Matrix2D.calculateResizeTransform(p,e,b,c.FitType.ProportionalFill),D=v._asterisk_Matrix2D_Matrix2D(s,y)),this.forma.placement=D}else{var S,x=e.transform(this.forma.placement.inverse),T=i.opt(t,function(e){return e.transform(n.forma.placement.inverse)}),M=null;if((S=i.opt(this.forma.contentNode,function(e){return e.focusRegion}))&&(M=g.ImageUtils.suggestCrop(this.forma.bounds.size,S,x,T,r)),null==M){var P=i.opt(i.as(this.forma,f.ImageForma),function(e){return e.contentNode});null!=P&&(M=new F.TheoRect(0,0,i.toDouble(P.pixelWidth),i.toDouble(P.pixelHeight)))}if(null!=M){this.forma.move(v.Matrix2D.uniformScaling(x.width/M.width));var k=this.forma.placement.transformPoint(M.center);this.forma.move(v.Matrix2D.translation(e.center.subtract(k)))}}else a.CoreAssert.fail("ERROR. image has no bounds. possibly a corrupted document")},processFormaClick:function(e){this.forma.parent.kind==m.FrameForma.KIND?(e.forma=this.forma.parent,this.forma.parent.controller.processFormaClick(e)):u.FormaController.prototype.processFormaClick.call(this,e)},processEvent:function(e){var t;return(t=i.as(e,d.BeginPointerTrackingEvent))?(t.trackingResponse=h.BeginPointerTrackingResponseEnum.TrackAsGroup,!1):u.FormaController.prototype.processEvent.call(this,e)},processEndFormaDrag:function(e){var t;u.FormaController.prototype.processEndFormaDrag.call(this,e),(t=i.as(i.opt(i.opt(this.forma,function(e){return e.parent}),function(e){return e.controller}),c.FrameController))&&t.fitChildrenToFrame()},afterProcessEndFormaDrag:function(e){var t;(t=i.as(i.opt(i.opt(this.forma,function(e){return e.parent}),function(e){return e.controller}),c.FrameController))&&t.fitChildrenToFrame()},processFormaDoubleClick:function(e){this.forma.parent.kind==m.FrameForma.KIND&&(e.forma=this.forma.parent),this.owner.selection.replaceSelection(e.forma),this.owner.selection.isSelected(e.forma)&&(this.owner.controllerSettingsState.settings=new l.ImageControllerSettings(this))},fit:function(e){var t,r;(t=this.forma)&&(t.placement=v.Matrix2D.Identity,(r=this.forma.frame)&&(b.TransformFacade.scaleForma(t,r.aspectRatio>=1?e.width/r.width:e.height/r.height),t.moveCenterToPoint(e.center)),this.updateParentGroup())},shuffleColorAssignment:function(){var e;if(!this.forma.isLogo()&&(e=i.as(i.opt(this.forma,function(e){return e.style}),p.ImageStyle))&&e.isColorizedFilter){var t=this.forma.page.imageFilterLibrary.getNextImageStyleOfSameType(e,!1);if(null!=t){var r,o;if(null!=(r=t.colors.colorID(s.ColorRole.FieldPrimary))){var n=(new C.ProfilingColorMap).overridePaletteMappingDueToContrast(r,this.forma.formaID);t.colors.setColorIDs([{key:s.ColorRole.FieldPrimary,value:n}])}null!=(o=t.colors.colorID(s.ColorRole.FieldSecondary))&&(n=(new C.ProfilingColorMap).overridePaletteMappingDueToContrast(o,this.forma.formaID+C.ProfilingColorMap.backingColorKey),t.colors.setColorIDs([{key:s.ColorRole.FieldSecondary,value:n}]))}this.forma.applyStyle(t)}}}}),o)},92:function(e,t,r){var o,n=t,i=r(0),a=r(1),l=r(79),s=r(156),u=r(19),c=r(11),h=r(29),d=r(25),m=r(43),f=r(23),p=r(239),g=r(21),v=r(14),C=r(72);n.RootController=(o=function(e,t,r){m.GroupController.call(this,e,t,r)},i.defineClass({name:"RootController",ctor:o,superName:"GroupController",statics:{KIND:{get:function(){return"root"}}},props:{selectable:{get:function(){return!0}},moveable:{get:function(){return!1}},deleteable:{get:function(){return!1}},replaceable:{get:function(){var e=i.clone(this.forma.filterByControllerKind(d.GridController.KIND)),t=i.clone(this.forma.filterWithCallback(function(e){return e.isBackgroundImage()}));return 0==e.length&&0==t.length}},processFormaDoubleClick:function(e){this.owner.controllerSettingsState.settings=new s.RootControllerSettings(this)},getSuggestableColors:function(){for(var e=i.clone(m.GroupController.prototype.getSuggestableColors.call(this)),t=i.iter(this.forma.filterWithCallback(function(e){return e.isTypeLockup()}));!t.done;t.next()){var r,o=t.value;if(r=i.as(o.controller,v.TypeLockupController)){var n=r.lockupStyle.colors.fieldPrimary;if(r.textBacked&&(n=r.lockupStyle.colors.fieldSecondary),null!=n){for(var a=[],l=i.iter(e);!l.done;l.next()){var s=l.value;s[0].rgbColor.contrasts(n,!1)&&a.push(i.clone(s))}return a}}}return e},suggestTransparentBackground:function(){var e=i.clone(C.TypeLockupUtils.getFullCanvasLockups(this.forma));if(e.length>0&&i.opt(e[0].lockupStyle,function(e){return 1==e.backingOpacity}))return!0;var t,r=this.forma.filterWithCallback(function(e){var t,r;return!(!(t=i.as(e,g.ImageForma))||!(r=i.as(e.parent,h.FrameForma)))&&!t.hasAlpha()&&r.isBackgroundImage()}).length,o=1,n=i.clone(this.forma.filterByControllerKind(d.GridController.KIND));return!(n.length>0&&(t=i.as(n[0].controller,d.GridController))&&(o=t.gridCells.length,t.margin>.01))&&(0==r&&1==o)},setBackgroundTransparency:function(e){var t=this;i.opt(this.forma,function(r){return r.style.colors.fieldPrimary=i.opt(i.opt(t.forma,function(e){return e.style.colors.fieldPrimary}),function(t){return t.withAlphaOf(e)})});for(var r=i.iter(this.forma.filterWithCallback(function(e){return d.GridController.isBackgroundColoredCell(e)}));!r.done;r.next())r.value.style.opacity=e},createGridControllerIfNone:function(){var e=i.clone(this.forma.filterByControllerKind(d.GridController.KIND));return 0==e.length&&(this.applyGridStyle(p.GridLibrary.instance.basicFullDesignGridStyle()),e=i.clone(this.forma.filterByControllerKind(d.GridController.KIND))),e.length>0?i.as(e[0].controller,d.GridController):null},getGridController:function(){var e=i.clone(this.forma.filterByControllerKind(d.GridController.KIND));return e.length>0?i.as(e[0].controller,d.GridController):null},applyGridStyle:function(e,t){void 0===t&&(t=0);var r=i.clone(this.forma.filterByControllerKind(d.GridController.KIND));r.length>1&&a.CoreAssert.fail("can't have more than one grid at the moment");var o=null,n=!1;if(0==r.length){var s=this.forma.root.page.createFormaWithController(f.GroupForma.KIND,d.GridController.KIND);s.applyStyle(p.GridLibrary.instance.basicFullDesignGridStyle()),this.forma.insertChildAt(s,0),o=i.as(s.controller,d.GridController),a.CoreAssert.isTrue(i.opt(o,function(e){return 1==e.gridCells.length}),"Created a brand new grid controller. Why isn't there 1 grid cell?"),n=!0}else o=i.as(r[0].controller,d.GridController);o.beginBlockedUpdate();var h=i.opt(this.forma,function(e){return e.bounds});o.forma.bounds=h;for(var m=i.iter(this.forma.visitAsArray(c.FormaTraversal.JustChildren));!m.done;m.next()){var g=m.value;i.eq(c._equality_Forma_Forma,g,o.forma)||(g.controller.moveable?o.forma.appendChild(g):o.forma.insertChildAt(g,0))}if(o.endBlockedUpdate(),o.applyStyle(e,t),n){var v,C=o.gridCells[0];null!=(v=this.forma.style.colors.colorID(u.ColorRole.FieldPrimary))&&(C.colorID=v,v!=l.ColorLibraryController.BLACK_KEY&&this.forma.style.colors.setColorId(u.ColorRole.FieldPrimary,"themeColor0"==v?"themeColor1":"themeColor0"),i.opt(o,function(e){return e.updateGroup()}))}}}}),o)}}]);
//# sourceMappingURL=logomaker-entry_13ac781b-b5ec1843.js.map